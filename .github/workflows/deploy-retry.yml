name: ğŸ”„ Retry Deploy EduGen to Azure

# Este workflow es para usar MANUALMENTE cuando el deployment principal falla
# debido a problemas de Azure SCM o conflictos de timing

on:
  workflow_dispatch:
    inputs:
      wait_time:
        description: 'Tiempo de espera antes del deployment (segundos)'
        required: false
        default: '90'
        type: string

env:
  AZURE_WEBAPP_NAME: edugen-app
  PYTHON_VERSION: '3.11'

jobs:
  retry-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“‹ Install dependencies (Quick mode)
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements-azure.txt
        
    - name: ğŸ“ Collect static files
      run: |
        export DJANGO_SETTINGS_MODULE="config.settings.github_actions"
        mkdir -p db
        python manage.py collectstatic --noinput --clear
        
    - name: ğŸ—‚ï¸ Prepare deployment
      run: |
        echo "ğŸ§¹ Cleaning unnecessary files..."
        rm -rf .git .github
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        chmod +x startup.sh
        echo "âœ… Deployment preparation completed"
        
    - name: â±ï¸ Extended pre-deployment wait
      run: |
        wait_time="${{ github.event.inputs.wait_time || '90' }}"
        echo "â±ï¸ Waiting $wait_time seconds to ensure Azure SCM is ready..."
        echo "ğŸ”§ This helps avoid SCM container restart conflicts"
        sleep $wait_time
        echo "âœ… Extended wait completed, Azure should be ready now"
        
    - name: ğŸš€ Deploy to Azure Web App (Retry Mode)
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: .
      timeout-minutes: 15
      
    - name: â±ï¸ Post-deployment stabilization
      run: |
        echo "â±ï¸ Waiting 30 seconds for deployment to stabilize..."
        sleep 30
        echo "âœ… Stabilization wait completed"
        
    - name: ğŸ” Comprehensive verification
      run: |
        echo "ğŸ” Performing comprehensive verification..."
        
        # Verificar mÃºltiples endpoints con retry
        endpoints=(
          "https://edugen-app.azurewebsites.net"
          "https://edugen-app.azurewebsites.net/admin/"
        )
        
        for endpoint in "${endpoints[@]}"; do
          echo "ğŸ” Checking $endpoint"
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            if curl -s -f -m 30 "$endpoint" > /dev/null; then
              echo "âœ… $endpoint is responding (attempt $attempt)"
              break
            else
              echo "â±ï¸ $endpoint not ready, attempt $attempt of $max_attempts"
              if [ $attempt -lt $max_attempts ]; then
                sleep 20
              fi
              attempt=$((attempt + 1))
            fi
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "âš ï¸ $endpoint verification failed after $max_attempts attempts"
          fi
        done
        
    - name: ğŸ¯ Retry deployment summary
      run: |
        echo "ğŸ‰ Retry deployment process completed!"
        echo "ğŸŒ App URL: https://edugen-app.azurewebsites.net"
        echo "ğŸ”§ Admin URL: https://edugen-app.azurewebsites.net/admin/"
        echo "ğŸ‘¤ Default admin: admin / EduGenAdmin123!"
        echo ""
        echo "ğŸ“‹ Si el deployment funcionÃ³ pero hay problemas:"
        echo "1. Revisar logs en Azure Portal: https://portal.azure.com"
        echo "2. Verificar App Service logs: https://edugen-app.scm.azurewebsites.net/api/logs/docker"
        echo "3. Comprobar variables de entorno en Azure"
        echo "4. Si es necesario, reiniciar App Service desde Azure Portal"
        echo ""
        echo "ğŸ”§ Comandos Ãºtiles para debugging:"
        echo "- Logs en tiempo real: az webapp log tail --name edugen-app --resource-group [tu-resource-group]"
        echo "- Estado del App Service: az webapp show --name edugen-app --resource-group [tu-resource-group]" 
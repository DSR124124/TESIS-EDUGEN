name: ğŸš€ Deploy EduGen to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: edugen-app
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“‹ Install dependencies
      run: |
        python -m pip install --upgrade pip
        echo "ğŸ“„ Contents of requirements-azure.txt:"
        cat requirements-azure.txt
        pip cache purge
        rm -rf ~/.cache/pip
        echo "ğŸ”§ Installing dependencies with force reinstall..."
        pip install --no-cache-dir --force-reinstall -r requirements-azure.txt
        pip list

    - name: ğŸ§ª Test ONLY imports (NO Django setup)
      run: |
        echo "ğŸ§ª Testing critical imports..."
        python -c "import django; print('âœ… Django OK')" || echo "âŒ Django import failed"
        python -c "import rest_framework; print('âœ… DRF OK')" || echo "âŒ rest_framework import failed"
        python -c "import crispy_forms; print('âœ… crispy_forms OK')" || echo "âŒ crispy_forms import failed"
        python -c "import crispy_bootstrap5; print('âœ… crispy_bootstrap5 OK')" || echo "âŒ crispy_bootstrap5 import failed"
        python -c "import social_django; print('âœ… social_django OK')" || echo "âŒ social_django import failed"
        python -c "import corsheaders; print('âœ… corsheaders OK')" || echo "âŒ corsheaders import failed"

    - name: ğŸ§ª Test Django setup with production settings
      run: |
        export DJANGO_SETTINGS_MODULE="config.settings.production"
        python -c "import os; print(f'DJANGO_SETTINGS_MODULE={os.environ.get(\"DJANGO_SETTINGS_MODULE\")}')"
        python -c "import django; django.setup(); print('âœ… Django setup successful')"

    - name: ğŸ“ Collect static files
      run: |
        export DJANGO_SETTINGS_MODULE="config.settings.production"
        echo "ğŸ”§ Running collectstatic..."
        python manage.py collectstatic --noinput --clear

    - name: ğŸ—‚ï¸ Prepare deployment
      run: |
        echo "ğŸ§¹ Cleaning unnecessary files..."
        rm -rf .git .github
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + || true
        chmod +x startup.sh || true
        echo "âœ… Deployment preparation completed"

    - name: ğŸ§¹ Clean Azure deployment state
      run: |
        echo "â±ï¸ Waiting to prevent SCM restart conflict..."
        sleep 90
        echo "âœ… Ready for deployment"

    - name: ğŸš€ Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: .
        clean: true
      timeout-minutes: 15

    - name: â±ï¸ Post-deployment wait
      run: |
        echo "â±ï¸ Waiting 30 seconds after deployment..."
        sleep 30

    - name: ğŸ” Verify deployment
      run: |
        echo "ğŸ” Verifying app URL..."
        max_attempts=5
        attempt=1
        while [ $attempt -le $max_attempts ]; do
          if curl -s -f -o /dev/null "https://edugen-app.azurewebsites.net"; then
            echo "âœ… App is responding!"
            break
          else
            echo "â±ï¸ App not ready, waiting..."
            sleep 30
            attempt=$((attempt + 1))
          fi
        done
        if [ $attempt -gt $max_attempts ]; then
          echo "âš ï¸ App failed to respond after $max_attempts attempts"
        fi

    - name: ğŸ¯ Post-deployment info
      run: |
        echo "ğŸ‰ Deployment completed!"
        echo "ğŸŒ App: https://edugen-app.azurewebsites.net"
        echo "ğŸ”§ Admin: https://edugen-app.azurewebsites.net/admin/"
        echo "ğŸ‘¤ Default admin: admin / EduGenAdmin123!"
        echo "ğŸ“‹ Tips:"
        echo "1. Verifica funcionamiento en el navegador"
        echo "2. Ejecuta migrate y createsuperuser vÃ­a SSH si aÃºn no lo hiciste"
        echo "3. Cambia credenciales por defecto"
        echo "ğŸ”— Portal: https://portal.azure.com"

name: ğŸš€ Deploy EduGen to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: edugen-app
  AZURE_WEBAPP_PACKAGE_PATH: '.'
  PYTHON_VERSION: '3.11'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“‹ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-azure.txt
        
    - name: ğŸ§ª Run basic checks
      run: |
        # Verificar sintaxis bÃ¡sica
        python -m py_compile manage.py
        
    - name: ğŸ“¦ Prepare deployment package
      run: |
        # Limpiar archivos innecesarios antes del despliegue
        rm -rf .git
        rm -rf .venv
        rm -rf __pycache__
        rm -rf db/sistema_educativo_db.sqlite3
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        
        # Verificar que startup.sh tenga permisos de ejecuciÃ³n
        chmod +x startup.sh
        
        # Listar archivos para debug
        echo "ğŸ“ Archivos en el directorio:"
        ls -la
        
    - name: ğŸ“¤ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: python-app
        path: |
          .
          !.git
          !.venv
          !db/sistema_educativo_db.sqlite3

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: ğŸ“¥ Download artifact
      uses: actions/download-artifact@v4
      with:
        name: python-app
        path: .

    - name: ğŸš€ Deploy to Azure Web App
      id: deploy-to-webapp
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

    - name: ğŸ¯ Post-deployment verification
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ App URL: https://edugen-app.azurewebsites.net"
        echo "ğŸ”§ Admin URL: https://edugen-app.azurewebsites.net/admin/"
        echo "ğŸ‘¤ Default admin: admin / EduGenAdmin123!"
        echo ""
        echo "ğŸ“‹ Next steps:"
        echo "1. Verificar que la app estÃ© funcionando"
        echo "2. Revisar logs en Azure Portal si hay problemas"
        echo "3. Configurar APIs externas (DeepSeek, Google OAuth)"
        echo "4. Cambiar credenciales por defecto" 
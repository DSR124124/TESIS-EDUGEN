name: 🚀 Deploy EduGen to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: edugen-app
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📦 Checkout code
      uses: actions/checkout@v4
      
    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: 📋 Install dependencies
      run: |
        python -m pip install --upgrade pip
        echo "📄 Contents of requirements-azure.txt:"
        cat requirements-azure.txt
        pip cache purge
        rm -rf ~/.cache/pip
        echo "🔧 Installing dependencies with force reinstall..."
        pip install --no-cache-dir --force-reinstall -r requirements-azure.txt
        pip list

    - name: 🧪 Test ONLY imports (NO Django setup)
      run: |
        echo "🧪 Testing critical imports..."
        python -c "import django; print('✅ Django OK')" || echo "❌ Django import failed"
        python -c "import rest_framework; print('✅ DRF OK')" || echo "❌ rest_framework import failed"
        python -c "import crispy_forms; print('✅ crispy_forms OK')" || echo "❌ crispy_forms import failed"
        python -c "import crispy_bootstrap5; print('✅ crispy_bootstrap5 OK')" || echo "❌ crispy_bootstrap5 import failed"
        python -c "import social_django; print('✅ social_django OK')" || echo "❌ social_django import failed"
        python -c "import corsheaders; print('✅ corsheaders OK')" || echo "❌ corsheaders import failed"

    - name: 🧪 Test Django setup with production settings
      run: |
        export DJANGO_SETTINGS_MODULE="config.settings.production"
        python -c "import os; print(f'DJANGO_SETTINGS_MODULE={os.environ.get(\"DJANGO_SETTINGS_MODULE\")}')"
        python -c "import django; django.setup(); print('✅ Django setup successful')"

    - name: 📁 Collect static files
      run: |
        export DJANGO_SETTINGS_MODULE="config.settings.production"
        echo "🔧 Running collectstatic..."
        python manage.py collectstatic --noinput --clear

    - name: 🗂️ Prepare deployment
      run: |
        echo "🧹 Cleaning unnecessary files..."
        rm -rf .git .github
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + || true
        chmod +x startup.sh || true
        echo "✅ Deployment preparation completed"

    - name: 🧹 Clean Azure deployment state
      run: |
        echo "⏱️ Waiting to prevent SCM restart conflict..."
        sleep 90
        echo "✅ Ready for deployment"

    - name: 🚀 Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: .
        clean: true
      timeout-minutes: 15

    - name: ⏱️ Post-deployment wait
      run: |
        echo "⏱️ Waiting 30 seconds after deployment..."
        sleep 30

    - name: 🔍 Verify deployment
      run: |
        echo "🔍 Verifying app URL..."
        max_attempts=5
        attempt=1
        while [ $attempt -le $max_attempts ]; do
          if curl -s -f -o /dev/null "https://edugen-app.azurewebsites.net"; then
            echo "✅ App is responding!"
            break
          else
            echo "⏱️ App not ready, waiting..."
            sleep 30
            attempt=$((attempt + 1))
          fi
        done
        if [ $attempt -gt $max_attempts ]; then
          echo "⚠️ App failed to respond after $max_attempts attempts"
        fi

    - name: 🎯 Post-deployment info
      run: |
        echo "🎉 Deployment completed!"
        echo "🌐 App: https://edugen-app.azurewebsites.net"
        echo "🔧 Admin: https://edugen-app.azurewebsites.net/admin/"
        echo "👤 Default admin: admin / EduGenAdmin123!"
        echo "📋 Tips:"
        echo "1. Verifica funcionamiento en el navegador"
        echo "2. Ejecuta migrate y createsuperuser vía SSH si aún no lo hiciste"
        echo "3. Cambia credenciales por defecto"
        echo "🔗 Portal: https://portal.azure.com"

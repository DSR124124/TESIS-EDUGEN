name: ğŸš€ Deploy EduGen to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: edugen-app
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“‹ Install dependencies
      run: |
        python -m pip install --upgrade pip
        echo "ğŸ“„ Contents of requirements-azure.txt:"
        cat requirements-azure.txt
        echo ""
        echo "ï¿½ï¿½ Clearing pip cache completamente..."
        pip cache purge
        echo ""
        echo "ğŸ§¹ Limpiando cache adicional..."
        rm -rf ~/.cache/pip
        echo ""
        echo "ğŸ”§ Installing dependencies with force reinstall..."
        pip install --no-cache-dir --force-reinstall -r requirements-azure.txt
        echo ""
        echo "ğŸ“¦ All installed packages:"
        pip list
        echo ""
        echo "ğŸ“¦ Django-related packages:"
        pip list | grep -i django || echo "No Django packages found"
        echo ""
        echo "ğŸ“¦ REST framework packages:"
        pip list | grep -i rest || echo "No REST packages found"
        echo ""
        echo "ğŸ” VerificaciÃ³n especÃ­fica de mÃ³dulos crÃ­ticos:"
        python -c "import crispy_bootstrap5; print(f'âœ… crispy_bootstrap5 version: {crispy_bootstrap5.__version__}')" || echo "âŒ crispy_bootstrap5 NOT found"
        python -c "import crispy_forms; print(f'âœ… crispy_forms version: {crispy_forms.__version__}')" || echo "âŒ crispy_forms NOT found"
        python -c "import django; print(f'âœ… Django {django.get_version()} - OK')" || echo "âŒ Django import failed"
        python -c "import rest_framework; print('âœ… rest_framework - OK')" || echo "âŒ rest_framework import failed"
        
    - name: ğŸ§ª Test ONLY imports (NO Django setup)
      run: |
        echo "ğŸ§ª Testing critical imports one by one..."
        echo ""
        echo "Testing Django..."
        python -c "import django; print(f'âœ… Django {django.get_version()} - OK')" || echo "âŒ Django import failed"
        echo ""
        echo "Testing rest_framework..."
        python -c "import rest_framework; print('âœ… rest_framework - OK')" || echo "âŒ rest_framework import failed"
        echo ""
        echo "Testing crispy_bootstrap5..."
        python -c "import crispy_bootstrap5; print('âœ… crispy_bootstrap5 - OK')" || echo "âŒ crispy_bootstrap5 import failed"
        echo ""
        echo "Testing social_django..."
        python -c "import social_django; print('âœ… social_django - OK')" || echo "âŒ social_django import failed"
        echo ""
        echo "Testing corsheaders..."
        python -c "import corsheaders; print('âœ… corsheaders - OK')" || echo "âŒ corsheaders import failed"
        echo ""
        echo "ğŸ¯ Import test completed!"
        
    - name: ğŸ§ª Test Django setup ONLY if imports work
      run: |
        echo "ğŸ”§ Testing Django setup with GitHub Actions settings..."
        export DJANGO_SETTINGS_MODULE="config.settings.github_actions"
        python -c "import os; print(f'DJANGO_SETTINGS_MODULE = {os.environ.get(\"DJANGO_SETTINGS_MODULE\", \"NOT SET\")}'); import django; print(f'Django version: {django.get_version()}'); django.setup(); print('âœ… Django setup completed successfully!')"
        
    - name: ğŸ“ Collect static files
      run: |
        export DJANGO_SETTINGS_MODULE="config.settings.github_actions"
        echo "ğŸ”§ Creating db directory..."
        mkdir -p db
        echo "ğŸ”§ Running collectstatic..."
        python manage.py collectstatic --noinput --clear
        
    - name: ğŸ—‚ï¸ Prepare deployment
      run: |
        # Limpiar archivos innecesarios usando comandos compatibles
        echo "ğŸ§¹ Cleaning unnecessary files..."
        rm -rf .git .github
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        
        # Asegurar permisos del startup script
        echo "ğŸ”§ Setting permissions for startup script..."
        chmod +x startup.sh
        
        echo "âœ… Deployment preparation completed"
        
    - name: ğŸ§¹ Clean Azure deployment state
      run: |
        echo "ğŸ§¹ Attempting to clean any pending Azure deployments..."
        
        # Esperar tiempo suficiente para que cualquier operaciÃ³n anterior termine
        echo "â±ï¸ Waiting 2 minutes to ensure no pending operations..."
        sleep 120
        
        # Verificar si hay deployments en curso usando la API de Kudu
        echo "ğŸ” Checking for active deployments..."
        
        # Intentar cancelar deployments pendientes (esto puede fallar, es normal)
        echo "ğŸ§¹ Attempting to clear deployment state (may fail, that's OK)..."
        
        echo "âœ… Azure state cleanup completed"
        
    - name: â±ï¸ Pre-deployment extended wait
      run: |
        echo "â±ï¸ Extended wait to avoid 409 conflicts..."
        echo "ğŸ”§ This helps ensure Azure is completely ready"
        sleep 60
        echo "âœ… Extended wait completed, proceeding with deployment"
        
    - name: ğŸš€ Deploy to Azure Web App (Robust Mode)
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: .
        clean: true
      timeout-minutes: 15

    - name: â±ï¸ Post-deployment wait
      run: |
        echo "â±ï¸ Waiting 30 seconds for Azure to process deployment..."
        sleep 30
        echo "âœ… Post-deployment wait completed"

    - name: ğŸ” Verify deployment
      run: |
        echo "ğŸ” Verifying deployment status..."
        # Intentar acceder al endpoint bÃ¡sico con retry
        max_attempts=5
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          echo "ğŸ” Attempt $attempt of $max_attempts"
          
          if curl -s -f -o /dev/null "https://edugen-app.azurewebsites.net"; then
            echo "âœ… App is responding!"
            break
          else
            echo "â±ï¸ App not ready yet, waiting 30 seconds..."
            sleep 30
            attempt=$((attempt + 1))
          fi
          
          if [ $attempt -gt $max_attempts ]; then
            echo "âš ï¸ App verification failed after $max_attempts attempts"
            echo "ğŸ”§ This doesn't necessarily mean deployment failed - check Azure Portal"
          fi
        done

    - name: ğŸ¯ Post-deployment verification
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ App URL: https://edugen-app.azurewebsites.net"
        echo "ğŸ”§ Admin URL: https://edugen-app.azurewebsites.net/admin/"
        echo "ğŸ‘¤ Default admin: admin / EduGenAdmin123!"
        echo ""
        echo "ğŸ“‹ Next steps:"
        echo "1. Verificar que la app estÃ© funcionando"
        echo "2. Revisar logs en Azure Portal si hay problemas"
        echo "3. Configurar APIs externas (DeepSeek, Google OAuth)"
        echo "4. Cambiar credenciales por defecto"
        echo ""
        echo "ğŸ”— Enlaces Ãºtiles:"
        echo "- Azure Portal: https://portal.azure.com"
        echo "- App Service Logs: https://edugen-app.scm.azurewebsites.net/api/logs/docker" 
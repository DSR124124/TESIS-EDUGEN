name: ğŸš€ Deploy EduGen to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: edugen-app
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“‹ Install dependencies
      run: |
        python -m pip install --upgrade pip
        echo "ğŸ“„ Contents of requirements-azure.txt:"
        cat requirements-azure.txt
        echo "ğŸ§¹ Clearing pip cache..."
        pip cache purge
        echo "ğŸ”§ Installing dependencies with verbose output..."
        pip install --no-cache-dir -r requirements-azure.txt -v
        echo "ğŸ“¦ Installed packages:"
        pip list | grep -E "(django|rest|crispy|social)"
        
    - name: ğŸ§ª Test Django setup
      run: |
        export DJANGO_SETTINGS_MODULE="config.settings.base"
        echo "ğŸ§ª Testing individual imports..."
        python -c "import django; print(f'âœ… Django {django.get_version()} installed successfully')"
        python -c "import rest_framework; print('âœ… rest_framework installed successfully')"
        python -c "import crispy_bootstrap5; print('âœ… crispy_bootstrap5 installed successfully')"
        python -c "import social_django; print('âœ… social_django installed successfully')"
        python -c "import corsheaders; print('âœ… corsheaders installed successfully')"
        
    - name: ğŸ“ Collect static files
      run: |
        export DJANGO_SETTINGS_MODULE="config.settings.base"
        python manage.py collectstatic --noinput --clear
        
    - name: ğŸ—‚ï¸ Prepare deployment
      run: |
        # Limpiar archivos innecesarios
        rm -rf .git
        rm -rf .github
        rm -rf __pycache__
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        
        # Asegurar permisos del startup script
        chmod +x startup.sh
        
    - name: ğŸš€ Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: .

    - name: ğŸ¯ Post-deployment verification
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ App URL: https://edugen-app.azurewebsites.net"
        echo "ğŸ”§ Admin URL: https://edugen-app.azurewebsites.net/admin/"
        echo "ğŸ‘¤ Default admin: admin / EduGenAdmin123!"
        echo ""
        echo "ğŸ“‹ Next steps:"
        echo "1. Verificar que la app estÃ© funcionando"
        echo "2. Revisar logs en Azure Portal si hay problemas"
        echo "3. Configurar APIs externas (DeepSeek, Google OAuth)"
        echo "4. Cambiar credenciales por defecto" 
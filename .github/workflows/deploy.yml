name: 🚀 Build and Deploy EduGen to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: edugen-app
  PYTHON_VERSION: '3.11'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📦 Checkout code
      uses: actions/checkout@v4
      
    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: 📋 Create virtual environment
      run: |
        python -m venv venv
        source venv/bin/activate
        echo "VIRTUAL_ENV=$(pwd)/venv" >> $GITHUB_ENV
        echo "$(pwd)/venv/bin" >> $GITHUB_PATH
        
    - name: 📦 Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-azure.txt
        
    - name: 🧪 Run Django checks
      run: |
        export DJANGO_SETTINGS_MODULE="config.settings.base"
        python manage.py check
        
    - name: 📁 Collect static files
      run: |
        export DJANGO_SETTINGS_MODULE="config.settings.base"
        python manage.py collectstatic --noinput --clear
        
    - name: 🗂️ Create deployment package
      run: |
        # Crear directorio de deployment
        mkdir deployment-package
        
        # Copiar código fuente
        cp -r . deployment-package/
        
        # Copiar entorno virtual
        cp -r venv deployment-package/
        
        # Crear script de activación para Azure
        cat > deployment-package/activate_venv.sh << 'EOF'
        #!/bin/bash
        export PATH="/home/site/wwwroot/venv/bin:$PATH"
        export VIRTUAL_ENV="/home/site/wwwroot/venv"
        EOF
        chmod +x deployment-package/activate_venv.sh
        
        # Limpiar archivos innecesarios
        find deployment-package -name "*.pyc" -delete
        find deployment-package -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        find deployment-package -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
        
    - name: 📤 Upload deployment package
      uses: actions/upload-artifact@v4
      with:
        name: python-app
        path: deployment-package/

  deploy:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: 📥 Download deployment package
      uses: actions/download-artifact@v4
      with:
        name: python-app
        path: .
        
    - name: 🚀 Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: .

    - name: 🎯 Post-deployment verification
      run: |
        echo "🎉 Deployment completed successfully!"
        echo "🌐 App URL: https://edugen-app.azurewebsites.net"
        echo "🔧 Admin URL: https://edugen-app.azurewebsites.net/admin/"
        echo "👤 Default admin: admin / EduGenAdmin123!"
        echo ""
        echo "📋 Next steps:"
        echo "1. Verificar que la app esté funcionando"
        echo "2. Revisar logs en Azure Portal si hay problemas"
        echo "3. Configurar APIs externas (DeepSeek, Google OAuth)"
        echo "4. Cambiar credenciales por defecto" 
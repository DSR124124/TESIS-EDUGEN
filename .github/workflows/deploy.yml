name: 🚀 Deploy EduGen to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: edugen-app
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📦 Checkout code
      uses: actions/checkout@v4
      
    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: 📋 Install dependencies
      run: |
        python -m pip install --upgrade pip
        echo "📄 Contents of requirements-azure.txt:"
        cat requirements-azure.txt
        echo "🧹 Clearing pip cache..."
        pip cache purge
        echo "🔧 Installing dependencies with verbose output..."
        pip install --no-cache-dir -r requirements-azure.txt -v
        echo "📦 Installed packages:"
        pip list | grep -E "(django|rest|crispy|social)"
        
    - name: 🧪 Test Django setup
      run: |
        export DJANGO_SETTINGS_MODULE="config.settings.base"
        echo "🧪 Testing individual imports..."
        python -c "import django; print(f'✅ Django {django.get_version()} installed successfully')"
        python -c "import rest_framework; print('✅ rest_framework installed successfully')"
        python -c "import crispy_bootstrap5; print('✅ crispy_bootstrap5 installed successfully')"
        python -c "import social_django; print('✅ social_django installed successfully')"
        python -c "import corsheaders; print('✅ corsheaders installed successfully')"
        
    - name: 📁 Collect static files
      run: |
        export DJANGO_SETTINGS_MODULE="config.settings.base"
        python manage.py collectstatic --noinput --clear
        
    - name: 🗂️ Prepare deployment
      run: |
        # Limpiar archivos innecesarios
        rm -rf .git
        rm -rf .github
        rm -rf __pycache__
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        
        # Asegurar permisos del startup script
        chmod +x startup.sh
        
    - name: 🚀 Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: .

    - name: 🎯 Post-deployment verification
      run: |
        echo "🎉 Deployment completed successfully!"
        echo "🌐 App URL: https://edugen-app.azurewebsites.net"
        echo "🔧 Admin URL: https://edugen-app.azurewebsites.net/admin/"
        echo "👤 Default admin: admin / EduGenAdmin123!"
        echo ""
        echo "📋 Next steps:"
        echo "1. Verificar que la app esté funcionando"
        echo "2. Revisar logs en Azure Portal si hay problemas"
        echo "3. Configurar APIs externas (DeepSeek, Google OAuth)"
        echo "4. Cambiar credenciales por defecto" 
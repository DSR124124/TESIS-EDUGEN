name: 🚀 Deploy EduGen to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: edugen-app
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📦 Checkout code
      uses: actions/checkout@v4
      
    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: 📋 Install dependencies
      run: |
        python -m pip install --upgrade pip
        echo "📄 Contents of requirements-azure.txt:"
        cat requirements-azure.txt
        echo ""
        echo "🧹 Clearing pip cache..."
        pip cache purge
        echo ""
        echo "🔧 Installing dependencies..."
        pip install --no-cache-dir -r requirements-azure.txt
        echo ""
        echo "📦 All installed packages:"
        pip list
        echo ""
        echo "📦 Django-related packages:"
        pip list | grep -i django || echo "No Django packages found"
        echo ""
        echo "📦 REST framework packages:"
        pip list | grep -i rest || echo "No REST packages found"
        echo ""
        echo "🔍 Specific check for djangorestframework:"
        pip show djangorestframework || echo "❌ djangorestframework NOT installed"
        
    - name: 🧪 Test ONLY imports (NO Django setup)
      run: |
        echo "🧪 Testing critical imports one by one..."
        echo ""
        echo "Testing Django..."
        python -c "import django; print(f'✅ Django {django.get_version()} - OK')" || echo "❌ Django import failed"
        echo ""
        echo "Testing rest_framework..."
        python -c "import rest_framework; print('✅ rest_framework - OK')" || echo "❌ rest_framework import failed"
        echo ""
        echo "Testing crispy_bootstrap5..."
        python -c "import crispy_bootstrap5; print('✅ crispy_bootstrap5 - OK')" || echo "❌ crispy_bootstrap5 import failed"
        echo ""
        echo "Testing social_django..."
        python -c "import social_django; print('✅ social_django - OK')" || echo "❌ social_django import failed"
        echo ""
        echo "Testing corsheaders..."
        python -c "import corsheaders; print('✅ corsheaders - OK')" || echo "❌ corsheaders import failed"
        echo ""
        echo "🎯 Import test completed!"
        
    - name: 🧪 Test Django setup ONLY if imports work
      run: |
        echo "🔧 Testing Django setup with GitHub Actions settings..."
        export DJANGO_SETTINGS_MODULE="config.settings.github_actions"
        python -c "import os; print(f'DJANGO_SETTINGS_MODULE = {os.environ.get(\"DJANGO_SETTINGS_MODULE\", \"NOT SET\")}'); import django; print(f'Django version: {django.get_version()}'); django.setup(); print('✅ Django setup completed successfully!')"
        
    - name: 📁 Collect static files
      run: |
        export DJANGO_SETTINGS_MODULE="config.settings.github_actions"
        echo "🔧 Creating db directory..."
        mkdir -p db
        echo "🔧 Running collectstatic..."
        python manage.py collectstatic --noinput --clear
        
    - name: 🗂️ Prepare deployment
      run: |
        # Limpiar archivos innecesarios usando comandos compatibles
        echo "🧹 Cleaning unnecessary files..."
        rm -rf .git .github
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        
        # Asegurar permisos del startup script
        echo "🔧 Setting permissions for startup script..."
        chmod +x startup.sh
        
        echo "✅ Deployment preparation completed"
        
    - name: 🚀 Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: .

    - name: 🎯 Post-deployment verification
      run: |
        echo "🎉 Deployment completed successfully!"
        echo "🌐 App URL: https://edugen-app.azurewebsites.net"
        echo "🔧 Admin URL: https://edugen-app.azurewebsites.net/admin/"
        echo "👤 Default admin: admin / EduGenAdmin123!"
        echo ""
        echo "📋 Next steps:"
        echo "1. Verificar que la app esté funcionando"
        echo "2. Revisar logs en Azure Portal si hay problemas"
        echo "3. Configurar APIs externas (DeepSeek, Google OAuth)"
        echo "4. Cambiar credenciales por defecto" 
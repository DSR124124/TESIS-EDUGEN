{% extends "dashboard/teacher/base.html" %}
{% load static %}
{% load portfolio_tags %}

{% block title %}Portafolio de {{ portfolio.student.user.get_full_name }}{% endblock %}

{% block extra_css %}
<style>
  :root {
    --sidebar-width: 280px;
    --primary-color: #005CFF;
    --primary-light: rgba(0, 92, 255, 0.1);
    --secondary-color: #A142F5;
    --accent-color: #8B5CF6;
    --success-color: #10B981;
    --warning-color: #F59E0B;
    --danger-color: #EF4444;
    --light-gray: #f8f9fa;
    --medium-gray: #e9ecef;
    --dark-gray: #495057;
    --border-radius: 12px;
    --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
    --transition-fast: all 0.2s ease;
    --transition-normal: all 0.3s ease;
    --text-secondary: #6B7280;
  }

  /* Content Container */
  .content-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
  }
  
  @media (max-width: 768px) {
    .content-container {
      padding: 15px;
    }
  }
  
  @media (max-width: 576px) {
    .content-container {
      padding: 10px;
    }
  }

  /* Breadcrumb Navigation */
  .dashboard-breadcrumb {
    margin-bottom: 20px;
    animation: fadeIn 0.5s ease-out;
  }

  .breadcrumb {
    background: white;
    border-radius: var(--border-radius);
    padding: 12px 20px;
    margin-bottom: 0;
    box-shadow: var(--shadow-sm);
    border: 1px solid rgba(0, 0, 0, 0.05);
    backdrop-filter: blur(10px);
  }

  .breadcrumb-item {
    display: flex;
    align-items: center;
    font-size: 0.9rem;
  }

  .breadcrumb-item + .breadcrumb-item::before {
    content: '›';
    color: var(--text-secondary);
    margin: 0 12px;
    font-weight: 600;
    font-size: 1.1rem;
  }

  .breadcrumb-link {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--primary-color);
    text-decoration: none;
    padding: 4px 8px;
    border-radius: 6px;
    transition: var(--transition-fast);
    font-weight: 500;
  }

  .breadcrumb-link:hover {
    background-color: var(--primary-light);
    color: var(--primary-color);
    transform: translateX(2px);
  }

  .breadcrumb-link i {
    font-size: 0.85rem;
  }

  .breadcrumb-item.active {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-secondary);
    font-weight: 600;
  }

  .breadcrumb-item.active i {
    font-size: 0.85rem;
    color: var(--primary-color);
  }

  /* Animaciones */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
  }

  @keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
  }

  .dashboard-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    border-radius: var(--border-radius);
    padding: 25px;
    color: white;
    box-shadow: 0 5px 15px rgba(0, 92, 255, 0.2);
    margin-bottom: 25px;
    position: relative;
    overflow: hidden;
    transition: var(--transition-normal);
    transform: translateY(0);
    animation: headerFadeIn 0.5s ease-out;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .dashboard-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 250px;
    height: 100%;
    background: url('{% static "img/pattern-dots.png" %}') no-repeat;
    background-size: cover;
    opacity: 0.15;
  }
  
  @keyframes headerFadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .dashboard-header:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 92, 255, 0.15);
  }

  .portfolio-container {
    border-radius: 15px;
    background-color: #fff;
    box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    padding: 25px;
    margin-bottom: 25px;
    transition: all 0.3s ease;
    animation: fadeInUp 0.8s;
  }

  .sidebar-card {
    border-radius: 15px;
    background-color: #fff;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    margin-bottom: 20px;
    overflow: hidden;
    transition: all 0.3s ease;
    animation: fadeInUp 0.8s;
  }

  .sidebar-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 92, 255, 0.15);
  }

  .sidebar-card-header {
    background: linear-gradient(135deg, #005CFF, #A142F5);
    color: white;
    padding: 15px;
    font-weight: 600;
  }

  .sidebar-card-body {
    padding: 15px;
  }

  .status-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 500;
    display: inline-block;
  }

  .section-header {
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--primary-light);
    font-weight: 600;
    color: var(--primary-color);
    position: relative;
  }

  .section-title {
    position: relative;
    padding-left: 15px;
    margin-bottom: 25px;
  }
    
  .section-title:before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 5px;
    background: linear-gradient(to bottom, #005CFF, #A142F5);
    border-radius: 20px;
  }

  .topic-section {
    background-color: #fff;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    margin-bottom: 20px;
    transition: all 0.3s ease;
    border-left: 4px solid var(--primary-color);
  }

  .topic-section:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 92, 255, 0.15);
  }

  .custom-btn-primary {
    background: linear-gradient(to right, #005CFF, #A142F5);
    border: none;
    color: white;
    box-shadow: 0 3px 8px rgba(0, 92, 255, 0.25);
    transition: all 0.3s ease;
    border-radius: 50px;
    padding: 10px 20px;
    font-weight: 500;
  }
    
  .custom-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(0, 92, 255, 0.3);
    color: white;
  }

  .info-label {
    font-weight: 600;
    color: var(--dark-gray);
    margin-right: 5px;
  }

  .info-value {
    color: var(--dark-gray);
  }

  .student-info-card {
    background-color: #fff;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
    border-left: 4px solid var(--primary-color);
    box-shadow: 0 6px 18px rgba(0,0,0,0.05);
  }

  .student-info-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 92, 255, 0.15);
  }

  .info-group {
    background-color: var(--light-gray);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
  }

  .info-group:hover {
    background-color: #f0f4ff;
    transform: translateY(-3px);
  }

  .student-avatar {
    width: 80px;
    height: 80px;
    background-color: var(--primary-light);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    border: 3px solid rgba(0, 92, 255, 0.1);
    transition: all 0.3s ease;
  }

  .student-avatar:hover {
    transform: scale(1.05);
    border-color: var(--primary-color);
  }

  .list-group-item-action:hover {
    background-color: var(--primary-light);
    color: var(--primary-color);
  }

  .list-group-item-action.active {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
  }

  .progress {
    height: 8px;
    border-radius: 10px;
    margin-bottom: 5px;
    overflow: hidden;
  }

  .progress-bar {
    transition: width 0.5s ease;
    background: linear-gradient(to right, #005CFF, #A142F5);
  }

  .progress-bar.bg-success {
    background: linear-gradient(to right, #10b981, #059669) !important;
  }

  .material-badge {
    padding: 5px 10px;
    border-radius: 50px;
    font-size: 0.85rem;
    margin-right: 5px;
    margin-bottom: 5px;
    display: inline-block;
    transition: all 0.3s ease;
  }

  .material-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  }

  .course-badge {
    background-color: var(--primary-light);
    color: var(--primary-color);
    border-radius: 50px;
    padding: 5px 15px;
    margin: 5px;
    display: inline-block;
    font-size: 0.85rem;
    transition: all 0.3s ease;
  }

  .course-badge:hover {
    transform: translateY(-2px);
    background-color: var(--primary-color);
    color: white;
  }

  /* Estilos para la sección de cursos */
  .course-section {
    border-radius: 15px;
    background-color: var(--light-gray);
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
  }

  .course-section:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }

  .course-section h4 {
    color: var(--primary-color);
    border-bottom: 2px solid var(--primary-light);
    padding-bottom: 10px;
    margin-bottom: 15px;
  }

  .courses-topics-container .topics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
  }



  /* Estilos para controles dinámicos */
  .course-accordion {
    margin-bottom: 15px;
  }

  .course-accordion .accordion-button {
    background: linear-gradient(135deg, #005CFF, #A142F5);
    color: white;
    font-weight: 600;
    border-radius: 10px;
    padding: 15px;
  }

  .course-accordion .accordion-button:not(.collapsed) {
    background: linear-gradient(135deg, #005CFF, #A142F5);
    color: white;
  }

  .course-accordion .accordion-button:focus {
    box-shadow: 0 0 0 0.25rem rgba(0, 92, 255, 0.25);
  }

  .course-accordion .accordion-body {
    padding: 20px;
    background-color: var(--light-gray);
    border-radius: 0 0 10px 10px;
  }

  .topics-pagination {
    display: flex;
    justify-content: center;
    margin-top: 15px;
  }

  .topics-pagination .page-link {
    color: var(--primary-color);
    border-color: var(--primary-light);
    background-color: white;
  }

  .topics-pagination .page-item.active .page-link {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
  }

  .controls-panel {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px 15px;
    background-color: var(--light-gray);
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.03);
    transition: all 0.3s ease;
  }

  .controls-panel:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
  }

  .topics-count {
    font-size: 0.9rem;
    color: var(--dark-gray);
    font-weight: 500;
  }

  .control-btn {
    border: none;
    background-color: transparent;
    color: var(--primary-color);
    font-size: 0.9rem;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 5px;
    transition: all 0.3s ease;
  }

  .control-btn:hover {
    background-color: var(--primary-light);
    transform: translateY(-2px);
  }

  .topics-grid {
    max-height: 600px;
    overflow-y: auto;
    padding-right: 5px;
  }

  /* Estilos para añadir scroll suave */
  .topics-grid::-webkit-scrollbar {
    width: 8px;
  }

  .topics-grid::-webkit-scrollbar-track {
    background: var(--light-gray);
    border-radius: 8px;
  }

  .topics-grid::-webkit-scrollbar-thumb {
    background-color: var(--medium-gray);
    border-radius: 8px;
  }

  .topics-grid::-webkit-scrollbar-thumb:hover {
    background-color: var(--dark-gray);
  }

  .filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 15px;
  }

  .filter-tag {
    background-color: var(--primary-light);
    color: var(--primary-color);
    border-radius: 50px;
    padding: 6px 15px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
  }

  .filter-tag:hover, .filter-tag.active {
    background-color: var(--primary-color);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 3px 8px rgba(0, 92, 255, 0.25);
  }

  .topic-card-footer {
    margin-top: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 10px;
    border-top: 1px solid var(--primary-light);
  }

  .floating-action-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(to right, #005CFF, #A142F5);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    transition: all 0.3s ease;
  }

  .floating-action-btn:hover {
    transform: scale(1.1) rotate(90deg);
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
  }

  .floating-action-btn i {
    font-size: 1.5rem;
  }

  .btn-group-sm .btn:hover {
    transform: translateY(-2px);
  }

  .btn-sm.btn-outline-primary {
    color: var(--primary-color);
    border-color: var(--primary-color);
  }

  .btn-sm.btn-outline-primary:hover {
    background-color: var(--primary-color);
    color: white;
  }

  .badge.bg-white {
    background-color: white !important;
    color: var(--primary-color);
    font-weight: 600;
  }

  /* COMPLETE RESPONSIVE OVERHAUL */
  /* Responsive styles for all screen sizes */
  @media (max-width: 992px) {
    .container-fluid {
      width: 100% !important;
      padding-left: 15px;
      padding-right: 15px;
    }
    
    .portfolio-container {
      padding: 20px;
    }
    
    .dashboard-header {
      padding: 20px;
    }
    
    .dashboard-header .row {
      flex-direction: column;
    }
    
    .dashboard-header .col-auto {
      width: 100%;
      margin-top: 15px;
    }
    
    .dashboard-header .d-flex.align-items-center {
      flex-wrap: wrap;
    }
    
    .dashboard-header .col {
      flex-basis: 100%;
    }
    
    .col-md-4, .col-md-8 {
      width: 100%;
      flex: 0 0 100%;
      max-width: 100%;
    }
    
    .topics-grid {
      grid-template-columns: 1fr;
      max-height: none;
    }
    
    .col-md-3, .col-md-5, .col-md-7 {
      width: 100%;
      flex: 0 0 100%;
      max-width: 100%;
      margin-bottom: 20px;
    }
  }
  
  /* Mobile-specific styles */
  @media (max-width: 768px) {
    body {
      overflow-x: hidden;
    }
    
    .container-fluid {
      padding: 10px;
    }
    
    .dashboard-header {
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .dashboard-header h2 {
      font-size: 1.25rem;
      margin-bottom: 5px;
    }
    

    
    .dashboard-header .d-flex.align-items-center {
      flex-direction: row;
      align-items: center !important;
    }
    
    .dashboard-header .col-auto .d-flex {
      flex-direction: column;
      align-items: flex-start !important;
    }
    
    .badge {
      display: inline-block;
      margin-bottom: 5px;
      font-size: 0.75rem;
      padding: 4px 8px;
    }
    
    .section-title {
      font-size: 1.1rem;
      margin-bottom: 15px;
    }
    
    .portfolio-container {
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .row {
      margin-left: -5px;
      margin-right: -5px;
    }
    
    .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-12, .col-6 {
      padding-left: 5px;
      padding-right: 5px;
    }
    
    .d-flex.justify-content-between {
      flex-direction: column;
      gap: 10px;
    }
    
    .d-flex.justify-content-between.align-items-center {
      align-items: flex-start !important;
    }
    
    .custom-btn-primary {
      width: 100%;
      text-align: center;
      margin-top: 10px;
    }
    
    .topics-count {
      display: block;
      margin-bottom: 10px;
    }
    
    .controls-panel {
      flex-direction: column;
      align-items: flex-start;
      padding: 10px;
    }
    
    .controls-panel > div {
      width: 100%;
      margin-bottom: 10px;
    }
    
    .topic-section {
      padding: 15px;
    }
    
    .topic-section .d-flex {
      flex-direction: column;
    }
    
    .topic-section .btn-group-sm {
      display: flex;
      margin-top: 15px;
      width: 100%;
      justify-content: space-between;
    }
    
    .topic-section .btn-group-sm .btn {
      flex-grow: 1;
      margin: 0 2px;
      border-radius: 4px;
      font-size: 1rem;
      padding: 8px 5px;
    }
    
    .course-accordion .accordion-button {
      padding: 12px;
    }
    
    .course-accordion .accordion-body {
      padding: 15px 10px;
    }
    
    .filter-tags {
      overflow-x: auto;
      white-space: nowrap;
      padding-bottom: 10px;
      flex-wrap: nowrap;
    }
    
    .filter-tag {
      flex: 0 0 auto;
    }
    
    .topic-card-footer {
      flex-direction: column;
    }
    
    .topic-card-footer > div {
      width: 100%;
    }
    
    .material-badge {
      font-size: 0.7rem;
      padding: 3px 8px;
    }
    
    /* Improved touch targets */
    .btn, a, .filter-tag, .control-btn {
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-group-sm .btn {
      min-height: 38px;
    }
    
    /* Fix for accordion controls */
    .accordion-button {
      min-height: 50px;
    }
    
    /* Fix floating button */
    .floating-action-btn {
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
    }
    
    /* Modal style fixes */
    .modal-dialog {
      margin: 10px;
    }
    
    .modal-content {
      border-radius: 10px;
    }
    
    /* Font size adjustments */
    .topic-section h4 {
      font-size: 1.1rem;
    }
    
    p, .info-value, .info-label {
      font-size: 0.9rem;
    }
    
    small, .small {
      font-size: 0.75rem;
    }
  }
  
  /* Small mobile fixes */
  @media (max-width: 480px) {
    .dashboard-header {
      padding: 12px;
    }
    
    .dashboard-header h2 {
      font-size: 1.1rem;
    }
    
    .portfolio-container {
      padding: 12px;
    }
    
    .section-title {
      font-size: 1rem;
    }
    
    .badge {
      font-size: 0.7rem;
      padding: 3px 6px;
    }
    
    .topic-section {
      padding: 12px;
    }
    
    .bg-light {
      padding: 8px !important;
    }
    
    h5 {
      font-size: 1rem;
    }
    
    h6 {
      font-size: 0.9rem;
    }
    
    .student-avatar {
      width: 60px;
      height: 60px;
    }
    
    .student-avatar i {
      font-size: 1.5rem !important;
    }
    
    .info-group {
      padding: 10px;
    }
    
    .course-accordion .accordion-button {
      font-size: 0.9rem;
      padding: 10px;
    }
    
    .progress {
      height: 6px;
    }
  }
</style>
{% endblock %}

{% block teacher_content %}
<div class="content-container">
    <!-- Mensajes flotantes -->
    {% include 'partials/_messages.html' %}

    <!-- Breadcrumb Navigation -->
    <nav class="dashboard-breadcrumb" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'dashboard:teacher' %}" class="breadcrumb-link">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'portfolios:teacher_portfolio_list' %}" class="breadcrumb-link">
                    <i class="fas fa-folder-open"></i>
                    <span>Portafolios</span>
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                <i class="fas fa-user-graduate"></i>
                <span>{{ portfolio.student.user.get_full_name }}</span>
            </li>
        </ol>
    </nav>

    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">Portafolio de {{ portfolio.student.user.get_full_name }}</h2>
                <p class="mb-0">{{ portfolio_month|default:portfolio.get_month_display }} {{ portfolio_year|default:portfolio.academic_year }}</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-12">
            <div class="portfolio-container">
                <!-- Student Information -->
                <div class="row">
                    <div class="col-md-4">
                        <div id="student-info" class="mb-4">
                            <h3 class="section-title">
                                <i class="fas fa-user-graduate me-2"></i>
                                Información del Estudiante
                            </h3>
                            <div class="student-info-card">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="d-flex justify-content-center mb-3">
                                            <div class="student-avatar">
                                                <i class="fas fa-user-graduate fa-2x text-primary"></i>
                                            </div>
                                        </div>
                                        <div class="text-center">
                                            <h5 class="fw-bold mb-1">{{ portfolio.student.user.get_full_name }}</h5>
                                            <p class="text-muted mb-0">{{ student_dni|default:"DNI no registrado" }}</p>
                                            <p class="text-muted">Código: {{ portfolio.student.student_code|default:"No disponible" }}</p>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="info-group mb-3">
                                            <h6 class="text-primary border-bottom pb-2 mb-2">
                                                <i class="fas fa-info-circle me-2"></i>Información de Contacto
                                            </h6>
                                            <p><span class="info-label"><i class="fas fa-envelope me-2 text-muted"></i>Email:</span> <span class="info-value">{{ portfolio.student.user.email }}</span></p>
                                            <p><span class="info-label"><i class="fas fa-phone me-2 text-muted"></i>Teléfono:</span> <span class="info-value">{{ portfolio.student.guardian_phone|default:"No registrado" }}</span></p>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <h6 class="text-primary border-bottom pb-2 mb-2">
                                            <i class="fas fa-chalkboard-teacher me-2"></i>Secciones
                                        </h6>
                                        <div class="d-flex flex-column">
                                            {% for section in student_sections %}
                                            <div class="mb-2 bg-light rounded p-2">
                                                <span class="fw-medium">
                                                    <i class="fas fa-chalkboard-teacher me-2 text-primary"></i>
                                                    {{ section.course.name|default:section.name }}
                                                </span>
                                                <p class="mb-0 small text-muted">{{ section.name }} - {{ section.grade.name|default:"" }}</p>
                                            </div>
                                            {% empty %}
                                            <div class="alert alert-warning">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                No hay secciones asignadas
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <!-- Portfolio Topics -->
                        <div id="portfolio-topics" class="topics-container">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h3 class="section-title mb-0">
                                    <i class="fas fa-book me-2"></i>
                                    Temas del Portafolio
                                </h3>
                            </div>
                            
                            {% if topics_by_course %}
                                <!-- Filtros y controles -->
                                {% if total_topics > 0 %}
                                <div class="controls-panel">
                                    <div>
                                        <span class="topics-count">
                                            <i class="fas fa-book me-1"></i> {{ total_topics }} temas en total
                                        </span>
                                    </div>
                                    <div>
                                        <button type="button" class="control-btn" id="expandAllBtn">
                                            <i class="fas fa-expand-alt me-1"></i> Expandir todo
                                        </button>
                                        <button type="button" class="control-btn" id="collapseAllBtn">
                                            <i class="fas fa-compress-alt me-1"></i> Colapsar todo
                                        </button>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Acordeón de cursos -->
                                <div class="accordion course-accordion" id="coursesAccordion">
                                    {% for course_id, course_data in topics_by_course.items %}
                                    <div class="accordion-item mb-3">
                                        <h2 class="accordion-header" id="heading{{ course_id }}">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ course_id }}" aria-expanded="true" aria-controls="collapse{{ course_id }}">
                                                <i class="fas fa-graduation-cap me-2"></i>
                                                {{ course_data.course_name }}
                                                <span class="badge bg-white text-primary ms-auto me-2">{{ course_data.topics|length }} temas</span>
                                            </button>
                                        </h2>
                                        <div id="collapse{{ course_id }}" class="accordion-collapse collapse show" aria-labelledby="heading{{ course_id }}" data-bs-parent="#coursesAccordion">
                                            <div class="accordion-body">
                                                {% if course_data.topics %}
                                                    <!-- Filtros por estado -->
                                                    <div class="filter-tags mb-3">
                                                        <div class="filter-tag active" data-filter="all">Todos</div>
                                                    </div>
                                                    
                                                    <div class="topics-grid">
                                                        {% for topic in course_data.topics %}
                                                        <div class="topic-section mb-3">
                                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                                <div>
                                                                    <h4 class="text-primary">{{ topic.title }}</h4>
                                                                    <p class="text-muted">{{ topic.description|truncatechars:100 }}</p>
                                                                    <div class="mt-2">
                                                                        <span class="badge bg-info ms-2">
                                                                            {% if topic.materials %}{{ topic.materials.count }}{% else %}0{% endif %} materiales
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                                <div class="btn-group btn-group-sm">
                                                                    <a href="{% url 'portfolios:topic_detail' topic.id %}" class="btn btn-outline-primary">
                                                                        <i class="fas fa-eye"></i> Ver
                                                                    </a>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="topic-card-footer">
                                                                <div>
                                                                    <p class="mb-2"><span class="info-label">Materiales:</span> <span class="info-value">{% if topic.materials %}{{ topic.materials.count }}{% else %}0{% endif %}</span></p>
                                                                    <div class="d-flex flex-wrap">
                                                                        {% if topic.materials.all %}
                                                                            {% for material in topic.materials.all|slice:":3" %}
                                                                            <span class="material-badge bg-secondary text-white">
                                                                                {% if material.material_type == 'EJERCICIO' %}
                                                                                    <i class="fas fa-tasks me-1"></i>
                                                                                {% elif material.material_type == 'TAREA' %}
                                                                                    <i class="fas fa-clipboard-list me-1"></i>
                                                                                {% elif material.material_type == 'EXAMEN' %}
                                                                                    <i class="fas fa-file-alt me-1"></i>
                                                                                {% elif material.material_type == 'PROYECTO' %}
                                                                                    <i class="fas fa-project-diagram me-1"></i>
                                                                                {% elif material.material_type == 'LECTURA' %}
                                                                                    <i class="fas fa-book-open me-1"></i>
                                                                                {% else %}
                                                                                    <i class="fas fa-file me-1"></i>
                                                                                {% endif %}
                                                                                {{ material.title|truncatechars:20 }}
                                                                            </span>
                                                                            {% endfor %}
                                                                            {% if topic.materials.count > 3 %}
                                                                                <span class="material-badge bg-primary text-white">
                                                                                    <i class="fas fa-ellipsis-h me-1"></i>
                                                                                    {{ topic.materials.count|add:"-3" }} más
                                                                                </span>
                                                                            {% endif %}
                                                                        {% else %}
                                                                            {% if topic.topic_type == 'portfolio' %}
                                                                                <span class="text-muted"><i class="fas fa-info-circle me-1"></i> No hay materiales</span>
                                                                            {% else %}
                                                                                <span class="text-muted"><i class="fas fa-info-circle me-1"></i> Tema de curso (sin materiales individuales)</span>
                                                                            {% endif %}
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <!-- Mensaje cuando no hay temas para este curso -->
                                                    <div class="alert alert-info text-center">
                                                        <i class="fas fa-book-open fa-2x text-primary mb-2"></i>
                                                        <h6 class="mb-2">No hay temas creados para {{ course_data.course_name }}</h6>
                                                        <p class="mb-0 small text-muted">Los temas para este curso se crean desde la sección de gestión de temas.</p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% elif topics %}
                                <div class="topics-grid">
                                    {% for topic in topics %}
                                    <div class="topic-section">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div>
                                                <h4 class="text-primary">{{ topic.title }}</h4>
                                                <p class="text-muted">{{ topic.description|truncatechars:100 }}</p>
                                                <div class="mt-2">
                                                    <span class="badge bg-info ms-2">
                                                        {% if topic.materials %}{{ topic.materials.count }}{% else %}0{% endif %} materiales
                                                    </span>
                                                    <span class="badge bg-primary ms-2">
                                                        {{ topic.course.name }}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{% url 'portfolios:topic_detail' topic.id %}" class="btn btn-outline-primary">
                                                    <i class="fas fa-eye"></i> Ver
                                                </a>
                                            </div>
                                        </div>
                                                
                                        <div class="topic-card-footer">
                                            <div>
                                                <p class="mb-2"><span class="info-label">Materiales:</span> <span class="info-value">{% if topic.materials %}{{ topic.materials.count }}{% else %}0{% endif %}</span></p>
                                                <div class="d-flex flex-wrap">
                                                    {% if topic.materials.all %}
                                                        {% for material in topic.materials.all|slice:":3" %}
                                                        <span class="material-badge bg-secondary text-white">
                                                            {% if material.material_type == 'EJERCICIO' %}
                                                                <i class="fas fa-tasks me-1"></i>
                                                            {% elif material.material_type == 'TAREA' %}
                                                                <i class="fas fa-clipboard-list me-1"></i>
                                                            {% elif material.material_type == 'EXAMEN' %}
                                                                <i class="fas fa-file-alt me-1"></i>
                                                            {% elif material.material_type == 'PROYECTO' %}
                                                                <i class="fas fa-project-diagram me-1"></i>
                                                            {% elif material.material_type == 'LECTURA' %}
                                                                <i class="fas fa-book-open me-1"></i>
                                                            {% else %}
                                                                <i class="fas fa-file me-1"></i>
                                                            {% endif %}
                                                            {{ material.title|truncatechars:20 }}
                                                        </span>
                                                        {% endfor %}
                                                        {% if topic.materials.count > 3 %}
                                                            <span class="material-badge bg-primary text-white">
                                                                <i class="fas fa-ellipsis-h me-1"></i>
                                                                {{ topic.materials.count|add:"-3" }} más
                                                            </span>
                                                        {% endif %}
                                                    {% else %}
                                                        {% if topic.topic_type == 'portfolio' %}
                                                            <span class="text-muted"><i class="fas fa-info-circle me-1"></i> No hay materiales</span>
                                                        {% else %}
                                                            <span class="text-muted"><i class="fas fa-info-circle me-1"></i> Tema de curso (sin materiales individuales)</span>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="alert alert-info" style="border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-left: 4px solid #005CFF;">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-info-circle me-3" style="font-size: 2rem; color: #005CFF;"></i>
                                        <div>
                                            <h5 class="mb-1">No hay temas en este portafolio</h5>
                                            <p class="mb-0">Este portafolio aún no tiene temas asignados. Puedes crear un nuevo tema haciendo clic en el botón "Nuevo tema".</p>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Debug para materiales
        console.log('Información de materiales:');
        console.log('Total de materiales: {{ total_materials|default:0 }}');

        
        // Añadir efectos de entrada en cascada con retraso progresivo
        const sections = document.querySelectorAll('.topic-section, .student-info-card');
        sections.forEach((section, index) => {
            section.style.opacity = '0';
            section.style.transform = 'translateY(20px)';
            setTimeout(() => {
                section.style.transition = 'all 0.5s ease';
                section.style.opacity = '1';
                section.style.transform = 'translateY(0)';
            }, 100 * index);
        });
        
        // Asegurar que los formularios de eliminación tengan el token CSRF
        const forms = document.querySelectorAll('form[action*="delete"]');
        forms.forEach(form => {
            if (!form.querySelector('input[name="csrfmiddlewaretoken"]')) {
                const token = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'csrfmiddlewaretoken';
                input.value = token;
                form.appendChild(input);
            }
        });
        
        // Efectos de hover mejorados
        const topicSections = document.querySelectorAll('.topic-section');
        topicSections.forEach(section => {
            section.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 8px 25px rgba(0, 92, 255, 0.15)';
                this.style.borderLeftWidth = '6px';
            });
            
            section.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 5px 15px rgba(0,0,0,0.05)';
                this.style.borderLeftWidth = '4px';
            });
        });
        
        // Expandir/colapsar todos los acordeones
        const expandAllBtn = document.getElementById('expandAllBtn');
        const collapseAllBtn = document.getElementById('collapseAllBtn');
        
        if (expandAllBtn) {
            expandAllBtn.addEventListener('click', function() {
                const collapseElements = document.querySelectorAll('.accordion-collapse');
                collapseElements.forEach(element => {
                    if (!element.classList.contains('show')) {
                        const bsCollapse = new bootstrap.Collapse(element, {
                            toggle: false
                        });
                        bsCollapse.show();
                    }
                });
            });
        }
        
        if (collapseAllBtn) {
            collapseAllBtn.addEventListener('click', function() {
                const collapseElements = document.querySelectorAll('.accordion-collapse');
                collapseElements.forEach(element => {
                    if (element.classList.contains('show')) {
                        const bsCollapse = new bootstrap.Collapse(element, {
                            toggle: false
                        });
                        bsCollapse.hide();
                    }
                });
            });
        }
        
        // Mejora de filtros con animaciones
        const filterTags = document.querySelectorAll('.filter-tag');
        filterTags.forEach(tag => {
            tag.addEventListener('click', function() {
                // Quitar clase activa de todos los filtros
                filterTags.forEach(t => t.classList.remove('active'));
                // Añadir clase activa al filtro seleccionado
                this.classList.add('active');
                
                const filter = this.getAttribute('data-filter');
                const topicElements = this.closest('.accordion-body').querySelectorAll('.topic-section');
                
                // Mostrar todos los temas ya que solo tenemos filtro "all"
                topicElements.forEach(topic => {
                    topic.style.transition = 'all 0.3s ease';
                    topic.style.display = 'block';
                    setTimeout(() => {
                        topic.style.opacity = '1';
                        topic.style.transform = 'translateY(0)';
                    }, 50);
                });
            });
        });
        
        // Añadir desplazamiento suave a los enlaces de anclaje
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                if (targetId === '#') return;
                
                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    window.scrollTo({
                        top: targetElement.offsetTop - 100,
                        behavior: 'smooth'
                    });
                }
            });
        });
        
        // Mobile specific adjustments
        const isMobile = window.innerWidth <= 768;
        
        if (isMobile) {
            // Collapse all accordions by default on mobile
            const accordionButtons = document.querySelectorAll('.accordion-button');
            accordionButtons.forEach(button => {
                if (!button.classList.contains('collapsed')) {
                    button.click();
                }
            });
            
            // Fix button heights on mobile
            document.querySelectorAll('.btn, .filter-tag, .control-btn').forEach(el => {
                // Keep original display style if not already set to flex
                if (window.getComputedStyle(el).display !== 'flex') {
                    el.style.display = 'inline-flex';
                }
            });
            
            // Add touch swipe for topic sections
            const topicSections = document.querySelectorAll('.topic-section');
            topicSections.forEach(section => {
                let startX;
                let startY;
                let touchStartTime;
                
                section.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    touchStartTime = new Date().getTime();
                }, { passive: true });
                
                section.addEventListener('touchend', (e) => {
                    const endX = e.changedTouches[0].clientX;
                    const endY = e.changedTouches[0].clientY;
                    const touchEndTime = new Date().getTime();
                    const touchDuration = touchEndTime - touchStartTime;
                    
                    // Calculate distance and direction
                    const diffX = startX - endX;
                    const diffY = startY - endY;
                    
                    // Only detect horizontal swipes (more horizontal than vertical)
                    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50 && touchDuration < 250) {
                        const btnGroup = section.querySelector('.btn-group-sm');
                        
                        // Swipe left - show actions
                        if (diffX > 50) {
                            if (btnGroup) {
                                btnGroup.style.display = 'flex';
                                btnGroup.style.opacity = '1';
                                btnGroup.style.transform = 'translateX(0)';
                            }
                        }
                        
                        // Swipe right - hide actions
                        if (diffX < -50) {
                            if (btnGroup) {
                                btnGroup.style.opacity = '0';
                                btnGroup.style.transform = 'translateX(100%)';
                                setTimeout(() => {
                                    btnGroup.style.display = 'none';
                                }, 300);
                            }
                        }
                    }
                }, { passive: true });
            });
            
            // Make stat cards scrollable horizontally if needed
            const statRows = document.querySelectorAll('.row.g-3');
            statRows.forEach(row => {
                if (row.scrollWidth > row.clientWidth) {
                    row.style.overflowX = 'auto';
                    row.style.flexWrap = 'nowrap';
                    row.style.paddingBottom = '10px';
                    
                    // Make child columns non-wrapping and same width
                    const cols = row.querySelectorAll('.col-md-3');
                    cols.forEach(col => {
                        col.style.flex = '0 0 150px';
                        col.style.width = '150px';
                        col.style.marginRight = '10px';
                    });
                }
            });
        }
    });
</script>
{% endblock %} 
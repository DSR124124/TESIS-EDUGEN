{% extends 'dashboard/teacher/base.html' %}

{% load static %}

{% block title %}Asignar Contenido{% endblock %}

{% block extra_css %}
<style>
    .material-type-card {
        transition: all 0.3s ease;
    }
    
    .material-type-card label {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid #e9ecef !important;
    }
    
    .material-type-card label:hover {
        border-color: #007bff !important;
        background-color: #f8f9fa;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
    }
    
    .material-type-card input[type="radio"]:checked + label {
        border-color: #007bff !important;
        background-color: #e7f3ff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
    }
    
    .material-type-card input[type="radio"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }
    
    .material-type-card input[value="personal"]:checked + label {
        border-color: #28a745 !important;
        background-color: #e8f5e8;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
    }
    
    .material-type-card input[value="personal"] + label:hover {
        border-color: #28a745 !important;
        background-color: #e8f5e8;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15);
    }
    
    .card {
        animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Estilos para las tarjetas de estudiantes */
    .student-card {
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
    }
    
    .student-card:hover {
        border-color: #28a745;
        background-color: #f8fff9;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15);
    }
    
    .student-card.selected {
        border-color: #28a745;
        background-color: #e8f5e8;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
    }
    
    .student-checkbox {
        transform: scale(1.2);
        margin-right: 10px;
    }
    
    .student-info {
        flex: 1;
    }
    
    .student-name {
        font-weight: 600;
        color: #495057;
        margin-bottom: 2px;
    }
    
    .student-details {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .students-grid {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 5px;
    }
    
    .students-grid::-webkit-scrollbar {
        width: 6px;
    }
    
    .students-grid::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .students-grid::-webkit-scrollbar-thumb {
        background: #28a745;
        border-radius: 3px;
    }
    
    .students-grid::-webkit-scrollbar-thumb:hover {
        background: #218838;
    }
</style>
{% endblock %}

{% block teacher_content %}
<!-- Loading Overlay -->
<div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); display: none; justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(5px);">
    <div style="text-align: center; background-color: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); max-width: 400px; width: 90%;">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem; margin-bottom: 1rem;" role="status"></div>
        <h5 class="mb-2 fw-bold" id="loadingMessage">Procesando asignación...</h5>
        <p class="text-muted mb-0 small">Este proceso puede tomar unos segundos.</p>
    </div>
</div>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0">Asignar Material</h3>
                            <p class="mb-0 text-white-50">{{ content.title }}</p>
                        </div>
                        <a href="{% url 'ai:content_detail' content.id %}" class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-left me-1"></i> Volver
                        </a>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Selección de tipo de asignación - Siempre mostrar las opciones -->
                    <div class="mb-4">
                        <h5 class="mb-3"><i class="fas fa-cog me-2 text-primary"></i>Tipo de Asignación</h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check material-type-card">
                                    <input class="form-check-input" type="radio" name="materialType" id="classMaterial" value="class">
                                    <label class="form-check-label w-100 p-3 border rounded" for="classMaterial">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-users fa-2x text-primary me-3"></i>
                                            <div>
                                                <h6 class="mb-1 text-primary">Material de Clase</h6>
                                                <small class="text-muted">Para todos los estudiantes</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check material-type-card">
                                    <input class="form-check-input" type="radio" name="materialType" id="personalMaterial" value="personal" checked>
                                    <label class="form-check-label w-100 p-3 border rounded" for="personalMaterial">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user fa-2x text-success me-3"></i>
                                            <div>
                                                <h6 class="mb-1 text-success">Material Personalizado</h6>
                                                <small class="text-muted">Solo para un estudiante</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Opciones para Material de Clase -->
                    <div id="classOptions" style="display: none;">
                        <h5 class="mb-3"><i class="fas fa-users me-2 text-primary"></i>Material de Clase</h5>
                        
                        <!-- Información del curso del contenido -->
                        <div class="alert alert-info mb-4">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-info-circle me-2 mt-1"></i>
                                <div>
                                    <strong>Curso del Contenido:</strong> {{ content.request.course.name }}
                                    <br><small class="text-muted">El material se asignará solo a estudiantes de este curso.</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Paso 1: Seleccionar Grado -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-2">
                                <span class="badge bg-primary me-2">1</span>
                                Seleccionar Grado
                            </h6>
                            <select id="gradeSelect" class="form-select">
                                <option value="" selected disabled>-- Selecciona un grado --</option>
                            </select>
                            <div class="form-text">
                                <i class="fas fa-graduation-cap me-1"></i>
                                Selecciona el grado donde quieres asignar el material
                            </div>
                        </div>
                        
                        <!-- Paso 2: Seleccionar Sección -->
                        <div class="mb-4" id="sectionStep" style="display: none;">
                            <h6 class="text-primary mb-2">
                                <span class="badge bg-primary me-2">2</span>
                                Seleccionar Sección
                            </h6>
                            <div id="sectionsLoading" class="text-muted small mb-2" style="display: none;">
                                <i class="fas fa-spinner fa-spin me-1"></i> 
                                Cargando secciones...
                            </div>
                            <select id="sectionSelect" class="form-select">
                                <option value="" selected disabled>-- Selecciona una sección --</option>
                            </select>
                            <div class="form-text">
                                <i class="fas fa-chalkboard me-1"></i>
                                Selecciona la sección específica para el material
                            </div>
                        </div>
                        
                        <!-- Paso 3: Seleccionar Tema -->
                        <div class="mb-3" id="topicStep" style="display: none;">
                            <h6 class="text-primary mb-2">
                                <span class="badge bg-primary me-2">3</span>
                                Seleccionar Tema del Curso
                            </h6>
                            <div id="courseTopicsLoading" class="text-muted small mb-2" style="display: none;">
                                <i class="fas fa-spinner fa-spin me-1"></i> 
                                Cargando temas del curso...
                            </div>
                            <select id="courseTopicSelectNew" class="form-select">
                                <option value="" selected disabled>-- Selecciona un tema --</option>
                            </select>
                            <div class="form-text">
                                <i class="fas fa-book me-1"></i>
                                El material se asignará a todos los estudiantes de esta sección bajo este tema
                            </div>
                        </div>
                        
                        <!-- Información de la asignación -->
                        <div id="assignmentSummary" class="alert alert-success" style="display: none;">
                            <h6 class="mb-2"><i class="fas fa-check-circle me-2"></i>Resumen de Asignación</h6>
                            <div id="assignmentDetails">
                            <div class="row">
                                <div class="col-md-6">
                                        <strong>Curso:</strong> {{ content.request.course.name }}<br>
                                        <strong>Grado:</strong> <span id="selectedGradeName">-</span><br>
                                        <strong>Sección:</strong> <span id="selectedSectionName">-</span>
                                </div>
                                <div class="col-md-6">
                                        <strong>Tema:</strong> <span id="selectedTopicName">-</span><br>
                                        <strong>Estudiantes:</strong> <span id="affectedStudents">-</span><br>
                                        <strong>Material:</strong> <span class="badge bg-info">SCORM</span>
                                </div>
                            </div>
                            </div>
                        </div>
                        
                        <!-- Mensajes de error/información -->
                        <div id="noGradesMessage" class="alert alert-warning" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i> 
                            No tienes grados asignados para el curso <strong>{{ content.request.course.name }}</strong>.
                        </div>
                        
                        <div id="noSectionsMessage" class="alert alert-warning" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i> 
                            No hay secciones disponibles para el grado seleccionado.
                        </div>
                        
                        <div id="noTopicsMessage" class="alert alert-warning" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i> 
                            No hay temas disponibles para la sección seleccionada.
                        </div>
                    </div>
                    
                    <!-- Opciones para Material Personalizado -->
                    <div id="personalOptions">
                        <h5 class="mb-3"><i class="fas fa-user me-2 text-success"></i>Material Personalizado</h5>
                        
                        <!-- Información del curso del contenido -->
                        <div class="alert alert-info mb-4">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-info-circle me-2 mt-1"></i>
                                <div>
                                    <strong>Curso del Contenido:</strong> {{ content.request.course.name }}
                                    <br><small class="text-muted">El material se asignará a estudiantes específicos de este curso.</small>
                                    </div>
                                </div>
                            </div>
                            
                        <!-- Paso 1: Seleccionar Grado -->
                        <div class="mb-4">
                            <h6 class="text-success mb-2">
                                <span class="badge bg-success me-2">1</span>
                                Seleccionar Grado
                            </h6>
                            <select id="personalGradeSelect" class="form-select">
                                <option value="" selected disabled>-- Selecciona un grado --</option>
                            </select>
                            <div class="form-text">
                                <i class="fas fa-graduation-cap me-1"></i>
                                Selecciona el grado de los estudiantes
                            </div>
                        </div>
                        
                        <!-- Paso 2: Seleccionar Sección -->
                        <div class="mb-4" id="personalSectionStep" style="display: none;">
                            <h6 class="text-success mb-2">
                                <span class="badge bg-success me-2">2</span>
                                Seleccionar Sección
                            </h6>
                            <div id="personalSectionsLoading" class="text-muted small mb-2" style="display: none;">
                                <i class="fas fa-spinner fa-spin me-1"></i> 
                                Cargando secciones...
                            </div>
                            <select id="personalSectionSelect" class="form-select">
                                <option value="" selected disabled>-- Selecciona una sección --</option>
                            </select>
                            <div class="form-text">
                                <i class="fas fa-chalkboard me-1"></i>
                                Selecciona la sección específica
                            </div>
                                </div>
                                
                        <!-- Paso 3: Seleccionar Tema -->
                        <div class="mb-4" id="personalTopicStep" style="display: none;">
                            <h6 class="text-success mb-2">
                                <span class="badge bg-success me-2">3</span>
                                Seleccionar Tema del Portafolio
                            </h6>
                            <div id="personalTopicsLoading" class="text-muted small mb-2" style="display: none;">
                                <i class="fas fa-spinner fa-spin me-1"></i> 
                                Cargando temas de portafolios...
                            </div>
                            <select id="personalTopicSelect" class="form-select">
                                        <option value="" selected disabled>-- Selecciona un tema --</option>
                                    </select>
                            <div class="form-text">
                                <i class="fas fa-book me-1"></i>
                                Selecciona el tema donde se agregará el material
                                    </div>
                                </div>
                                
                        <!-- Paso 4: Seleccionar Estudiantes -->
                        <div class="mb-3" id="personalStudentsStep" style="display: none;">
                            <h6 class="text-success mb-3">
                                <span class="badge bg-success me-2">4</span>
                                Seleccionar Estudiantes
                                <span id="selectedStudentsCount" class="badge bg-secondary ms-2" style="display: none;">0 seleccionados</span>
                            </h6>
                            
                            <div id="personalStudentsLoading" class="text-muted small mb-2" style="display: none;">
                                <i class="fas fa-spinner fa-spin me-1"></i> 
                                Cargando estudiantes...
                            </div>
                            
                            <!-- Controles de selección -->
                            <div id="studentsControls" class="mb-3" style="display: none;">
                                <div class="d-flex gap-2 flex-wrap">
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="selectAllStudents()">
                                        <i class="fas fa-check-double me-1"></i> Seleccionar Todos
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="deselectAllStudents()">
                                        <i class="fas fa-times me-1"></i> Deseleccionar Todos
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Lista de estudiantes -->
                            <div id="personalStudentsList" class="row" style="display: none;">
                                <!-- Los estudiantes se cargarán dinámicamente -->
                            </div>
                            
                            <div id="noStudentsMessage" class="alert alert-warning" style="display: none;">
                                    <i class="fas fa-exclamation-triangle me-2"></i> 
                                No hay estudiantes disponibles para esta sección y tema.
                                    </div>
                                </div>
                                
                        <!-- Resumen de asignación personalizada -->
                        <div id="personalAssignmentSummary" class="alert alert-success" style="display: none;">
                            <h6 class="mb-2"><i class="fas fa-check-circle me-2"></i>Resumen de Asignación Personalizada</h6>
                            <div id="personalAssignmentDetails">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Curso:</strong> {{ content.request.course.name }}<br>
                                        <strong>Grado:</strong> <span id="personalSelectedGradeName">-</span><br>
                                        <strong>Sección:</strong> <span id="personalSelectedSectionName">-</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Tema:</strong> <span id="personalSelectedTopicName">-</span><br>
                                        <strong>Estudiantes:</strong> <span id="personalSelectedStudentsCount">-</span><br>
                                        <strong>Material:</strong> <span class="badge bg-info">Personalizado</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mensajes de error/información para material personalizado -->
                        <div id="personalNoGradesMessage" class="alert alert-warning" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i> 
                            No tienes grados asignados para el curso <strong>{{ content.request.course.name }}</strong>.
                            </div>
                        
                        <div id="personalNoSectionsMessage" class="alert alert-warning" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i> 
                            No hay secciones disponibles para el grado seleccionado.
                        </div>
                        
                        <div id="personalNoTopicsMessage" class="alert alert-warning" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i> 
                            No hay temas de portafolio disponibles para esta sección y curso.
                        </div>
                    </div>
                    
                    <!-- Botón de asignación -->
                    <div class="d-grid mt-4">
                        <button id="assignButton" class="btn btn-primary btn-lg" disabled>
                            <i class="fas fa-paper-plane me-2"></i> Asignar Material
                        </button>
                        <div class="text-center mt-2">
                            <small class="text-muted" id="assignButtonHelp">
                                <i class="fas fa-info-circle me-1"></i> Completa los campos requeridos
                            </small>
                        </div>
                        

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSRF Token -->
{% csrf_token %}

<!-- Portfolio Topics Data -->
<script id="portfolio-topics-data" type="application/json">{{ portfolio_topics|safe }}</script>
<script id="content-data" type="application/json">
{
    "id": {{ content.id }},
    "title": "{{ content.title|escapejs }}",
    "class_info": {% if class_info %}
    {
        "tema_nombre": "{{ class_info.tema_nombre|escapejs }}"
    }
    {% else %}null{% endif %}
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var studentSelect = document.getElementById('studentSelect');
    var topicSelect = document.getElementById('topicSelect');
    var assignButton = document.getElementById('assignButton');
    var classOptions = document.getElementById('classOptions');
    var personalOptions = document.getElementById('personalOptions');
    
    // Nuevos elementos para el flujo de clase
    var gradeSelect = document.getElementById('gradeSelect');
    var sectionSelect = document.getElementById('sectionSelect');
    var courseTopicSelectNew = document.getElementById('courseTopicSelectNew');
    var sectionStep = document.getElementById('sectionStep');
    var topicStep = document.getElementById('topicStep');
    var assignmentSummary = document.getElementById('assignmentSummary');
    
    // Nuevos elementos para el flujo de material personalizado
    var personalGradeSelect = document.getElementById('personalGradeSelect');
    var personalSectionSelect = document.getElementById('personalSectionSelect');
    var personalTopicSelect = document.getElementById('personalTopicSelect');
    var personalSectionStep = document.getElementById('personalSectionStep');
    var personalTopicStep = document.getElementById('personalTopicStep');
    var personalStudentsStep = document.getElementById('personalStudentsStep');
    var personalAssignmentSummary = document.getElementById('personalAssignmentSummary');
    var personalStudentsList = document.getElementById('personalStudentsList');
    
    var selectedStudentId = null;
    var selectedTopicId = null;
    var selectedMaterialType = 'personal';
    var selectedGradeId = null;
    var selectedSectionId = null;
    var selectedCourseTopicId = null;
    
    // Variables para material personalizado
    var personalSelectedGradeId = null;
    var personalSelectedSectionId = null;
    var personalSelectedTopicId = null;
    var selectedStudentIds = [];  // Array para múltiples estudiantes
    
    // Hacer variables accesibles globalmente para debug
    window.selectedMaterialType = selectedMaterialType;
    window.personalSelectedGradeId = personalSelectedGradeId;
    window.personalSelectedSectionId = personalSelectedSectionId;
    window.personalSelectedTopicId = personalSelectedTopicId;
    window.selectedStudentIds = selectedStudentIds;
    window.checkAssignButtonState = checkAssignButtonState;
    
    var allTopics = [];
    var contentData = {};
    
    // Cargar datos del JSON
    try {
        var portfolioTopicsScript = document.getElementById('portfolio-topics-data');
        if (portfolioTopicsScript) {
            allTopics = JSON.parse(portfolioTopicsScript.textContent);
        }
        
        var contentDataScript = document.getElementById('content-data');
        if (contentDataScript) {
            contentData = JSON.parse(contentDataScript.textContent);
        }
        
        console.log("Datos cargados - Temas:", allTopics.length, "Contenido:", contentData);
    } catch (e) {
        console.error("Error al cargar datos:", e);
        allTopics = [];
        contentData = {};
    }
    
    // Inicializar vista según el tipo de material seleccionado por defecto
    var initialMaterialType = document.querySelector('input[name="materialType"]:checked');
    if (initialMaterialType) {
        selectedMaterialType = initialMaterialType.value;
        if (selectedMaterialType === 'class') {
            classOptions.style.display = 'block';
            personalOptions.style.display = 'none';
            loadGrades();
        } else {
            classOptions.style.display = 'none';
            personalOptions.style.display = 'block';
            loadPersonalGrades();
        }
    }

    // Manejar cambio de tipo de material
    document.querySelectorAll('input[name="materialType"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            selectedMaterialType = this.value;
            
            if (selectedMaterialType === 'class') {
                classOptions.style.display = 'block';
                personalOptions.style.display = 'none';
                loadGrades();
                resetPersonalSelection();
            } else {
                classOptions.style.display = 'none';
                personalOptions.style.display = 'block';
                loadPersonalGrades();
                resetClassSelection();
            }
            
            checkAssignButtonState();
        });
    });
    
    // Manejar selección de grado
    if (gradeSelect) {
        gradeSelect.addEventListener('change', function() {
            selectedGradeId = this.value;
            console.log('Grado seleccionado:', selectedGradeId);
            
            if (selectedGradeId) {
                loadSections(selectedGradeId);
                sectionStep.style.display = 'block';
            } else {
                resetSectionAndTopic();
            }
            
            checkAssignButtonState();
        });
    }
    
    // Manejar selección de sección
    if (sectionSelect) {
        sectionSelect.addEventListener('change', function() {
            selectedSectionId = this.value;
            console.log('Sección seleccionada:', selectedSectionId);
            
            if (selectedSectionId) {
                loadCourseTopics(selectedSectionId);
                topicStep.style.display = 'block';
            } else {
                resetTopicSelection();
            }
            
            checkAssignButtonState();
        });
    }
    
    // Manejar selección de tema del curso
    if (courseTopicSelectNew) {
        courseTopicSelectNew.addEventListener('change', function() {
            selectedCourseTopicId = this.value;
            console.log('Tema del curso seleccionado:', selectedCourseTopicId);
            
            if (selectedCourseTopicId) {
                showAssignmentSummary();
            } else {
                hideAssignmentSummary();
            }
            
            checkAssignButtonState();
        });
    }
    
    // Manejar selección de estudiante (material personalizado)
    if (studentSelect) {
        studentSelect.addEventListener('change', function() {
            selectedStudentId = this.value;
            if (selectedStudentId) {
                loadStudentTopics(selectedStudentId);
            }
            checkAssignButtonState();
        });
    }
    
    // Manejar selección de tema (material personalizado)
    if (topicSelect) {
        topicSelect.addEventListener('change', function() {
            selectedTopicId = this.value;
            checkAssignButtonState();
        });
    }
    
    // Manejar asignación
    if (assignButton) {
        assignButton.addEventListener('click', function() {
            console.log('=== BOTÓN ASIGNAR PRESIONADO ===');
            console.log('Tipo de material seleccionado:', selectedMaterialType);
            console.log('Botón habilitado:', !assignButton.disabled);
            
            if (selectedMaterialType === 'class') {
                console.log('Ejecutando asignación de clase...');
                assignContentToClass();
            } else {
                console.log('Ejecutando asignación personalizada...');
                assignContentToTopic();
            }
        });
    }
    
    // MANEJADORES PARA MATERIAL PERSONALIZADO
    
    // Manejar selección de grado personalizado
    if (personalGradeSelect) {
        personalGradeSelect.addEventListener('change', function() {
            personalSelectedGradeId = this.value;
            window.personalSelectedGradeId = personalSelectedGradeId;
            console.log('Grado personalizado seleccionado:', personalSelectedGradeId);
            
            if (personalSelectedGradeId) {
                loadPersonalSections(personalSelectedGradeId);
                personalSectionStep.style.display = 'block';
        } else {
                resetPersonalSectionAndTopic();
            }
            
            checkAssignButtonState();
        });
    }
    
    // Manejar selección de sección personalizada
    if (personalSectionSelect) {
        personalSectionSelect.addEventListener('change', function() {
            personalSelectedSectionId = this.value;
            window.personalSelectedSectionId = personalSelectedSectionId;
            console.log('Sección personalizada seleccionada:', personalSelectedSectionId);
            
            if (personalSelectedSectionId) {
                loadPersonalTopics(personalSelectedSectionId);
                personalTopicStep.style.display = 'block';
            } else {
                resetPersonalTopicAndStudents();
            }
            
            checkAssignButtonState();
        });
    }
    
    // Manejar selección de tema personalizado
    if (personalTopicSelect) {
        personalTopicSelect.addEventListener('change', function() {
            personalSelectedTopicId = this.value;
            window.personalSelectedTopicId = personalSelectedTopicId;
            console.log('Tema personalizado seleccionado:', personalSelectedTopicId);
            
            if (personalSelectedTopicId) {
                loadPersonalStudents(personalSelectedSectionId, personalSelectedTopicId);
                personalStudentsStep.style.display = 'block';
            } else {
                resetPersonalStudents();
            }
            
            checkAssignButtonState();
        });
    }
    
    // FUNCIONES PARA CARGAR DATOS
    
    function loadGrades() {
        console.log('Cargando grados...');
        hideMessages();
        
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        var courseId = contentData.course_id || {{ content.request.course.id }};
        
        fetch(`/ai/api/get-grades-for-course/${courseId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Respuesta de grados:', data);
            
            if (data.success && data.grades && data.grades.length > 0) {
                populateGradeSelect(data.grades);
            } else {
                showMessage('noGradesMessage');
            }
        })
        .catch(error => {
            console.error('Error al cargar grados:', error);
            showMessage('noGradesMessage');
        });
    }
    
    function loadSections(gradeId) {
        console.log('Cargando secciones para grado:', gradeId);
        showLoading('sectionsLoading');
        
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        var courseId = {{ content.request.course.id }};
        
        fetch(`/ai/api/get-sections-for-grade/${gradeId}/${courseId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading('sectionsLoading');
            console.log('Respuesta de secciones:', data);
            
            if (data.success && data.sections && data.sections.length > 0) {
                populateSectionSelect(data.sections);
            } else {
                showMessage('noSectionsMessage');
            }
        })
        .catch(error => {
            hideLoading('sectionsLoading');
            console.error('Error al cargar secciones:', error);
            showMessage('noSectionsMessage');
        });
    }
    
    function loadCourseTopics(sectionId) {
        console.log('Cargando temas del curso para sección:', sectionId);
        showLoading('courseTopicsLoading');
        
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        var courseId = {{ content.request.course.id }};
        
        fetch(`/ai/api/get-course-topics/${sectionId}/${courseId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading('courseTopicsLoading');
            console.log('Respuesta de temas:', data);
            
            if (data.success && data.topics && data.topics.length > 0) {
                populateCourseTopicSelect(data.topics);
            } else {
                showMessage('noTopicsMessage');
            }
        })
        .catch(error => {
            hideLoading('courseTopicsLoading');
            console.error('Error al cargar temas:', error);
            showMessage('noTopicsMessage');
        });
    }
    
    // FUNCIONES PARA CARGAR DATOS DEL MATERIAL PERSONALIZADO
    
    function loadPersonalGrades() {
        console.log('Cargando grados para material personalizado...');
        hidePersonalMessages();
        
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        var courseId = contentData.course_id || {{ content.request.course.id }};
        
        fetch(`/ai/api/get-grades-for-course/${courseId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Respuesta de grados personalizados:', data);
            
            if (data.success && data.grades && data.grades.length > 0) {
                populatePersonalGradeSelect(data.grades);
            } else {
                showPersonalMessage('personalNoGradesMessage');
            }
        })
        .catch(error => {
            console.error('Error al cargar grados personalizados:', error);
            showPersonalMessage('personalNoGradesMessage');
        });
    }
    
    function loadPersonalSections(gradeId) {
        console.log('Cargando secciones personalizadas para grado:', gradeId);
        showLoading('personalSectionsLoading');
        
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        var courseId = {{ content.request.course.id }};
        
        fetch(`/ai/api/get-sections-for-grade/${gradeId}/${courseId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading('personalSectionsLoading');
            console.log('Respuesta de secciones personalizadas:', data);
            
            if (data.success && data.sections && data.sections.length > 0) {
                populatePersonalSectionSelect(data.sections);
            } else {
                showPersonalMessage('personalNoSectionsMessage');
            }
        })
        .catch(error => {
            hideLoading('personalSectionsLoading');
            console.error('Error al cargar secciones personalizadas:', error);
            showPersonalMessage('personalNoSectionsMessage');
        });
    }
    
    function loadPersonalTopics(sectionId) {
        console.log('Cargando temas personalizados para sección:', sectionId);
        showLoading('personalTopicsLoading');
        
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        var courseId = {{ content.request.course.id }};
        
        fetch(`/ai/api/get-portfolio-topics/${sectionId}/${courseId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading('personalTopicsLoading');
            console.log('Respuesta de temas personalizados:', data);
            
            if (data.success && data.topics && data.topics.length > 0) {
                populatePersonalTopicSelect(data.topics);
            } else {
                showPersonalMessage('personalNoTopicsMessage');
            }
        })
        .catch(error => {
            hideLoading('personalTopicsLoading');
            console.error('Error al cargar temas personalizados:', error);
            showPersonalMessage('personalNoTopicsMessage');
        });
    }
    
    function loadPersonalStudents(sectionId, topicId) {
        console.log('Cargando estudiantes para sección:', sectionId, 'y tema:', topicId);
        showLoading('personalStudentsLoading');
        
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch(`/ai/api/get-students-for-topic/${sectionId}/${topicId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading('personalStudentsLoading');
            console.log('Respuesta de estudiantes:', data);
            
            if (data.success && data.students && data.students.length > 0) {
                populateStudentsList(data.students);
                document.getElementById('studentsControls').style.display = 'block';
                personalStudentsList.style.display = 'block';
            } else {
                document.getElementById('noStudentsMessage').style.display = 'block';
            }
        })
        .catch(error => {
            hideLoading('personalStudentsLoading');
            console.error('Error al cargar estudiantes:', error);
            document.getElementById('noStudentsMessage').style.display = 'block';
        });
    }
    
    // FUNCIONES AUXILIARES
    
    function populateGradeSelect(grades) {
        gradeSelect.innerHTML = '<option value="" selected disabled>-- Selecciona un grado --</option>';
        grades.forEach(grade => {
                    var option = document.createElement('option');
            option.value = grade.id;
            option.textContent = grade.name;
            gradeSelect.appendChild(option);
        });
    }
    
    function populateSectionSelect(sections) {
        sectionSelect.innerHTML = '<option value="" selected disabled>-- Selecciona una sección --</option>';
        sections.forEach(section => {
            var option = document.createElement('option');
            option.value = section.id;
            option.textContent = `Sección ${section.name} (${section.students_count} estudiantes)`;
            sectionSelect.appendChild(option);
        });
    }
    
    function populateCourseTopicSelect(topics) {
        courseTopicSelectNew.innerHTML = '<option value="" selected disabled>-- Selecciona un tema --</option>';
        topics.forEach(topic => {
            var option = document.createElement('option');
            option.value = topic.id;
            option.textContent = topic.title;
            option.dataset.description = topic.description || '';
            courseTopicSelectNew.appendChild(option);
        });
    }
    
    function showAssignmentSummary() {
        if (!selectedGradeId || !selectedSectionId || !selectedCourseTopicId) return;
        
        // Actualizar información en el resumen
        var gradeText = gradeSelect.options[gradeSelect.selectedIndex].text;
        var sectionText = sectionSelect.options[sectionSelect.selectedIndex].text;
        var topicText = courseTopicSelectNew.options[courseTopicSelectNew.selectedIndex].text;
        
        document.getElementById('selectedGradeName').textContent = gradeText;
        document.getElementById('selectedSectionName').textContent = sectionText;
        document.getElementById('selectedTopicName').textContent = topicText;
        
        // Simular conteo de estudiantes (se podría hacer una llamada AJAX para obtener el número exacto)
        var studentsMatch = sectionText.match(/\((\d+) estudiantes\)/);
        var studentsCount = studentsMatch ? studentsMatch[1] : 'N/A';
        document.getElementById('affectedStudents').textContent = studentsCount;
        
        assignmentSummary.style.display = 'block';
    }
    
    function hideAssignmentSummary() {
        assignmentSummary.style.display = 'none';
    }
    
    function resetClassSelection() {
        selectedGradeId = null;
        selectedSectionId = null;
        selectedCourseTopicId = null;
        resetSectionAndTopic();
    }
    
    function resetSectionAndTopic() {
        selectedSectionId = null;
        selectedCourseTopicId = null;
        sectionStep.style.display = 'none';
        resetTopicSelection();
    }
    
    function resetTopicSelection() {
        selectedCourseTopicId = null;
        topicStep.style.display = 'none';
        hideAssignmentSummary();
    }
    
    function showLoading(elementId) {
        var element = document.getElementById(elementId);
        if (element) element.style.display = 'block';
    }
    
    function hideLoading(elementId) {
        var element = document.getElementById(elementId);
        if (element) element.style.display = 'none';
    }
    
    function showMessage(messageId) {
        hideMessages();
        var element = document.getElementById(messageId);
        if (element) element.style.display = 'block';
    }
    
    function hideMessages() {
        ['noGradesMessage', 'noSectionsMessage', 'noTopicsMessage'].forEach(id => {
            var element = document.getElementById(id);
            if (element) element.style.display = 'none';
        });
    }
    
    function checkAssignButtonState() {
    var canAssign = false;
    var helpText = '';
    
    // Obtener valores directamente del DOM para asegurar que estén actualizados
    var materialType = document.querySelector('input[name="materialType"]:checked');
    var currentMaterialType = materialType ? materialType.value : 'personal';
    
    if (currentMaterialType === 'class') {
        var gradeSelect = document.getElementById('gradeSelect');
        var sectionSelect = document.getElementById('sectionSelect');
        var courseTopicSelect = document.getElementById('courseTopicSelectNew');
        
        var gradeValue = gradeSelect ? gradeSelect.value : '';
        var sectionValue = sectionSelect ? sectionSelect.value : '';
        var topicValue = courseTopicSelect ? courseTopicSelect.value : '';
        
        canAssign = gradeValue && sectionValue && topicValue;
        
        if (!gradeValue) helpText = 'Selecciona un grado';
        else if (!sectionValue) helpText = 'Selecciona una sección';
        else if (!topicValue) helpText = 'Selecciona un tema del curso';
        else helpText = 'Listo para asignar a toda la clase';
        } else {
        // Material personalizado - obtener valores directamente del DOM
        var personalGradeSelect = document.getElementById('personalGradeSelect');
        var personalSectionSelect = document.getElementById('personalSectionSelect');
        var personalTopicSelect = document.getElementById('personalTopicSelect');
        var checkedStudents = document.querySelectorAll('.student-checkbox:checked');
        
        var personalGradeValue = personalGradeSelect ? personalGradeSelect.value : '';
        var personalSectionValue = personalSectionSelect ? personalSectionSelect.value : '';
        var personalTopicValue = personalTopicSelect ? personalTopicSelect.value : '';
        var studentsCount = checkedStudents.length;
        
        canAssign = personalGradeValue && personalSectionValue && personalTopicValue && studentsCount > 0;
        
        if (!personalGradeValue) helpText = 'Selecciona un grado';
        else if (!personalSectionValue) helpText = 'Selecciona una sección';
        else if (!personalTopicValue) helpText = 'Selecciona un tema';
        else if (studentsCount === 0) helpText = 'Selecciona al menos un estudiante';
        else helpText = `Listo para asignar a ${studentsCount} estudiante(s)`;
        
        // Actualizar variables para la función de asignación
        personalSelectedGradeId = personalGradeValue;
        personalSelectedSectionId = personalSectionValue;
        personalSelectedTopicId = personalTopicValue;
        
        // Actualizar array de estudiantes seleccionados
        selectedStudentIds = [];
        checkedStudents.forEach(checkbox => {
            if (checkbox.checked) {
                selectedStudentIds.push(parseInt(checkbox.dataset.studentId));
            }
        });
    }
    
    if (assignButton) {
        assignButton.disabled = !canAssign;
    }
    
    var helpElement = document.getElementById('assignButtonHelp');
    if (helpElement) {
        helpElement.innerHTML = '<i class="fas fa-info-circle me-1"></i> ' + helpText;
    }
}


    
    function loadStudentTopics(studentId) {
        // Ocultar elemento de "seleccionar estudiante primero"
        var selectStudentFirst = document.getElementById('selectStudentFirst');
        if (selectStudentFirst) {
            selectStudentFirst.style.display = 'none';
        }
        
        // Mostrar loading
        var topicsLoading = document.getElementById('topicsLoading');
        var topicSelectContainer = document.getElementById('topicSelectContainer');
        var noTopicsMessage = document.getElementById('noTopicsMessage');
        
        if (topicsLoading) topicsLoading.style.display = 'block';
        if (topicSelectContainer) topicSelectContainer.style.display = 'none';
        if (noTopicsMessage) noTopicsMessage.style.display = 'none';
        
        // Reset topic selection
        selectedTopicId = null;
        checkAssignButtonState();
        
        // Realizar petición AJAX para obtener temas del estudiante
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch('{% url "ai:get_student_topics" 0 %}'.replace('0', studentId), {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            // Ocultar loading
            if (topicsLoading) topicsLoading.style.display = 'none';
            
            if (data.success) {
                
                // Cargar temas
                if (data.topics && data.topics.length > 0) {
                    if (topicSelectContainer) {
                        topicSelectContainer.style.display = 'block';
                    }
                    
                    // Limpiar y llenar selector de temas
                    topicSelect.innerHTML = '<option value="" selected disabled>-- Selecciona un tema --</option>';
                    
                    data.topics.forEach(function(topic) {
                        var option = document.createElement('option');
                        option.value = topic.id;
                        option.textContent = `${topic.title} (${topic.course_name})`;
                        option.title = `Curso: ${topic.course_name} | Período: ${topic.portfolio_period}`;
                        topicSelect.appendChild(option);
                    });
                    
                    // Actualizar información del filtro
                    var topicFilterInfo = document.getElementById('topicFilterInfo');
                    if (topicFilterInfo) {
                        var teacherName = data.teacher_info ? data.teacher_info.name : 'usted';
                        topicFilterInfo.textContent = `${data.topics.length} tema(s) de ${data.courses.length} curso(s) que dicta ${teacherName}`;
                    }
                } else {
                    // No hay temas
                    if (noTopicsMessage) {
                        var noTopicsMsg = noTopicsMessage.querySelector('strong');
                        var noTopicsDetail = noTopicsMessage.querySelector('.small');
                        if (noTopicsMsg) noTopicsMsg.textContent = 'No hay temas en sus cursos';
                        if (noTopicsDetail) {
                            if (data.message) {
                                noTopicsDetail.textContent = data.message;
                            } else {
                                noTopicsDetail.textContent = 'Este estudiante no tiene temas en los cursos que usted dicta.';
                            }
                        }
                        noTopicsMessage.style.display = 'block';
                    }
                }
                
            } else {
                // Error del servidor
                console.error('Error del servidor:', data.message);
                if (noTopicsMessage) {
                    var noTopicsMsg = noTopicsMessage.querySelector('strong');
                    var noTopicsDetail = noTopicsMessage.querySelector('.small');
                    if (noTopicsMsg) noTopicsMsg.textContent = 'Error al cargar temas';
                    if (noTopicsDetail) noTopicsDetail.textContent = data.message || 'Error desconocido del servidor';
                    noTopicsMessage.style.display = 'block';
                }
            }
        })
        .catch(function(error) {
            console.error('Error en la petición AJAX:', error);
            
            // Ocultar loading
            if (topicsLoading) topicsLoading.style.display = 'none';
            
            // Mostrar mensaje de error
            if (noTopicsMessage) {
                var noTopicsMsg = noTopicsMessage.querySelector('strong');
                var noTopicsDetail = noTopicsMessage.querySelector('.small');
                if (noTopicsMsg) noTopicsMsg.textContent = 'Error de conexión';
                if (noTopicsDetail) noTopicsDetail.textContent = 'No se pudieron cargar los temas. Verifique su conexión.';
                noTopicsMessage.style.display = 'block';
            }
        });
    }
    
    function assignContentToTopic() {
        // Obtener valores directamente del DOM
        var personalTopicSelect = document.getElementById('personalTopicSelect');
        var checkedStudents = document.querySelectorAll('.student-checkbox:checked');
        
        var topicId = personalTopicSelect ? personalTopicSelect.value : '';
        var studentIds = [];
        checkedStudents.forEach(checkbox => {
            if (checkbox.checked) {
                studentIds.push(parseInt(checkbox.dataset.studentId));
            }
        });
        
        if (!topicId) {
            alert('Error: No se ha seleccionado un tema.');
            return;
        }
        
        if (studentIds.length === 0) {
            alert('Error: No se han seleccionado estudiantes.');
            return;
        }
        
        if (!contentData || !contentData.id) {
            alert('Error: No se encontraron los datos del contenido.');
            return;
        }
        
        showLoading(`Asignando contenido a ${studentIds.length} estudiante(s)...`);
        
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        var formData = {
            content_id: contentData.id,
            topic_id: topicId,
            material_name: contentData.title,
            material_type: 'personal',
            target_students: studentIds  // Array de IDs de estudiantes
        };
        
        fetch("{% url 'ai:assign_to_portfolio_api' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(formData)
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            hideLoading();
            if (data.success) {
                showSuccessNotification(
                    '¡Material personalizado asignado exitosamente!',
                    `Materiales creados: ${data.materials_created || studentIds.length} | Estudiantes procesados: ${studentIds.length}`
                );
                
                setTimeout(function() {
                window.location.href = "{% url 'ai:content_detail' content.id %}";
                }, 2000);
            } else {
                alert('Error: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(function(error) {
            hideLoading();
            console.error('Error:', error);
            alert('Error al procesar la solicitud: ' + error.message);
        });
    }
    
    function assignContentToClass() {
        showLoading('Asignando contenido a toda la clase...');
        
        // Obtener el título del tema seleccionado
        var topicText = courseTopicSelectNew.options[courseTopicSelectNew.selectedIndex].text;
        
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        var formData = {
            content_id: contentData.id,
            material_name: contentData.title,
            material_type: 'class',
            course_topic_title: topicText,
            target_sections: [selectedSectionId]  // Solo la sección seleccionada
        };
        
        console.log('Enviando datos para material de clase:', formData);
        
        fetch("{% url 'ai:assign_to_portfolio_api' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(formData)
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            hideLoading();
            if (data.success) {
                // Mostrar notificación flotante de éxito
                showSuccessNotification(
                    '¡Material de clase asignado exitosamente!',
                    'Materiales creados: ' + (data.materials_created || 0) + ' | Estudiantes procesados: ' + (data.students_processed || 0)
                );
                
                // Redirigir a la vista del tema después de un breve delay
                setTimeout(function() {
                    window.location.href = "{% url 'ai:content_detail' content.id %}";
                }, 2000);
            } else {
                alert('Error: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(function(error) {
            hideLoading();
            console.error('Error:', error);
            alert('Error al procesar la solicitud: ' + error.message);
        });
    }
});
    
// Funciones de loading
    function showLoading(message) {
        var loadingMessage = document.getElementById('loadingMessage');
        var loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingMessage) {
        loadingMessage.textContent = message || 'Procesando...';
        }
        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
        }
    }
    
    function hideLoading() {
        var loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
    }
    
// Función para mostrar notificación flotante de éxito
function showSuccessNotification(title, message) {
    // Crear el contenedor de notificación si no existe
    var notificationContainer = document.getElementById('notificationContainer');
    if (!notificationContainer) {
        notificationContainer = document.createElement('div');
        notificationContainer.id = 'notificationContainer';
        notificationContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
            width: 90%;
        `;
        document.body.appendChild(notificationContainer);
    }
    
    // Crear la notificación
    var notification = document.createElement('div');
    notification.style.cssText = `
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
        margin-bottom: 15px;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        border-left: 5px solid #fff;
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 12px;">
            <div style="flex-shrink: 0; background: rgba(255,255,255,0.2); border-radius: 50%; padding: 8px; margin-top: 2px;">
                <i class="fas fa-check" style="font-size: 1.2rem;"></i>
            </div>
            <div style="flex: 1;">
                <h6 style="margin: 0 0 8px 0; font-weight: 600; font-size: 1.1rem;">${title}</h6>
                <p style="margin: 0; font-size: 0.9rem; opacity: 0.9; line-height: 1.4;">${message}</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" style="
                background: none; border: none; color: white; opacity: 0.7; 
                font-size: 1.2rem; cursor: pointer; padding: 0; margin: 0;
            ">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    notificationContainer.appendChild(notification);
    
    // Animar entrada
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Auto-eliminar después de 5 segundos
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 500);
    }, 5000);
}

function assignToEntireClass() {
    if (!confirm('¿Estás seguro de que deseas asignar este contenido a toda la clase?\n\nEsta acción creará el material en todos los portafolios de los estudiantes.')) {
        return;
    }
    
    var loadingMessage = document.getElementById('loadingMessage');
    var loadingOverlay = document.getElementById('loadingOverlay');
    
    if (loadingMessage) {
        loadingMessage.textContent = 'Asignando contenido a toda la clase...';
    }
    if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
    }
    
    var contentDataScript = document.getElementById('content-data');
    var contentData = {};
    if (contentDataScript) {
        contentData = JSON.parse(contentDataScript.textContent);
    }
    
    var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    var formData = {
        content_id: contentData.id,
        material_name: contentData.title,
        material_type: 'class',
        course_topic_title: contentData.class_info ? contentData.class_info.tema_nombre : ''
    };
    
    fetch("{% url 'ai:assign_to_portfolio_api' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(formData)
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
        if (data.success) {
            // Mostrar notificación flotante de éxito
            showSuccessNotification(
                '¡Material de clase asignado exitosamente!',
                'Materiales creados: ' + (data.materials_created || 0) + ' | Estudiantes procesados: ' + (data.students_processed || 0)
            );
            
            // Redirigir a la lista de temas después de un breve delay
            setTimeout(function() {
                window.location.href = "{% url 'portfolios:teacher_portfolio_list' %}";
            }, 2000);
        } else {
            alert('Error: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(function(error) {
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
        console.error('Error:', error);
        alert('Error al procesar la solicitud: ' + error.message);
    });
}

// Función para mostrar/ocultar lista completa de estudiantes
function toggleStudentList() {
    var studentPreview = document.getElementById('studentPreview');
    var allStudents = document.getElementById('allStudents');
    var toggleButton = document.getElementById('toggleStudents');
    
    if (allStudents.style.display === 'none') {
        // Mostrar todos
        studentPreview.style.display = 'none';
        allStudents.style.display = 'block';
        toggleButton.innerHTML = '<i class="fas fa-eye-slash me-1"></i> Ver menos estudiantes';
    } else {
        // Mostrar solo preview
        studentPreview.style.display = 'block';
        allStudents.style.display = 'none';
        toggleButton.innerHTML = '<i class="fas fa-eye me-1"></i> Ver todos los estudiantes';
    }
}

// FUNCIONES AUXILIARES PARA MATERIAL PERSONALIZADO

function populatePersonalGradeSelect(grades) {
    personalGradeSelect.innerHTML = '<option value="" selected disabled>-- Selecciona un grado --</option>';
    grades.forEach(grade => {
        var option = document.createElement('option');
        option.value = grade.id;
        option.textContent = grade.name;
        personalGradeSelect.appendChild(option);
    });
}

function populatePersonalSectionSelect(sections) {
    personalSectionSelect.innerHTML = '<option value="" selected disabled>-- Selecciona una sección --</option>';
    sections.forEach(section => {
        var option = document.createElement('option');
        option.value = section.id;
        option.textContent = `Sección ${section.name} (${section.students_count} estudiantes)`;
        personalSectionSelect.appendChild(option);
    });
}

function populatePersonalTopicSelect(topics) {
    personalTopicSelect.innerHTML = '<option value="" selected disabled>-- Selecciona un tema --</option>';
    topics.forEach(topic => {
        var option = document.createElement('option');
        option.value = topic.id;
        option.textContent = topic.title;
        option.dataset.description = topic.description || '';
        personalTopicSelect.appendChild(option);
    });
}

function populateStudentsList(students) {
    personalStudentsList.innerHTML = '';
    selectedStudentIds = []; // Reset array
    
    students.forEach(student => {
        var colDiv = document.createElement('div');
        colDiv.className = 'col-md-6 col-lg-4 mb-2';
        
        var cardDiv = document.createElement('div');
        cardDiv.className = 'student-card d-flex align-items-center';
        cardDiv.onclick = function() { toggleStudentSelection(student.id, cardDiv); };
        
        cardDiv.innerHTML = `
            <input type="checkbox" class="student-checkbox" data-student-id="${student.id}" 
                   onchange="handleStudentCheckboxChange(${student.id}, this)" 
                   onclick="event.stopPropagation()">
            <div class="student-info">
                <div class="student-name">${student.name}</div>
                <div class="student-details">ID: ${student.id}</div>
        </div>
    `;
    
        colDiv.appendChild(cardDiv);
        personalStudentsList.appendChild(colDiv);
    });
    
    updateSelectedStudentsCount();
}

function toggleStudentSelection(studentId, cardElement) {
    // Evitar que se dispare cuando se hace click en el checkbox directamente
    var checkbox = cardElement.querySelector('.student-checkbox');
    if (event && event.target === checkbox) return;
    
    checkbox.checked = !checkbox.checked;
    handleStudentCheckboxChange(studentId, checkbox);
}

function handleStudentCheckboxChange(studentId, checkbox) {
    var cardElement = checkbox.closest('.student-card');
    
    // Actualizar clase visual
    if (checkbox.checked) {
        if (cardElement) cardElement.classList.add('selected');
    } else {
        if (cardElement) cardElement.classList.remove('selected');
    }
    
    // Actualizar contador y verificar botón
    updateSelectedStudentsCount();
    checkAssignButtonState();
    
    // Mostrar/ocultar resumen basado en estudiantes seleccionados
    var checkedStudents = document.querySelectorAll('.student-checkbox:checked');
    if (checkedStudents.length > 0) {
        showPersonalAssignmentSummary();
    } else {
        hidePersonalAssignmentSummary();
    }
}

function selectAllStudents() {
    var checkboxes = document.querySelectorAll('.student-checkbox');
    checkboxes.forEach(checkbox => {
        if (!checkbox.checked) {
            checkbox.checked = true;
            // Actualizar clase visual
            var cardElement = checkbox.closest('.student-card');
            if (cardElement) cardElement.classList.add('selected');
        }
    });
    
    updateSelectedStudentsCount();
    checkAssignButtonState();
    showPersonalAssignmentSummary();
}

function deselectAllStudents() {
    var checkboxes = document.querySelectorAll('.student-checkbox');
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            checkbox.checked = false;
            // Actualizar clase visual
            var cardElement = checkbox.closest('.student-card');
            if (cardElement) cardElement.classList.remove('selected');
        }
    });
    
    updateSelectedStudentsCount();
    checkAssignButtonState();
    hidePersonalAssignmentSummary();
}

function updateSelectedStudentsCount() {
    var checkedStudents = document.querySelectorAll('.student-checkbox:checked');
    var count = checkedStudents.length;
    
    var countElement = document.getElementById('selectedStudentsCount');
    if (countElement) {
        countElement.textContent = `${count} seleccionados`;
        countElement.style.display = count > 0 ? 'inline' : 'none';
    }
}

function showPersonalAssignmentSummary() {
    if (!personalSelectedGradeId || !personalSelectedSectionId || !personalSelectedTopicId || selectedStudentIds.length === 0) return;
    
    // Actualizar información en el resumen
    var gradeText = personalGradeSelect.options[personalGradeSelect.selectedIndex].text;
    var sectionText = personalSectionSelect.options[personalSectionSelect.selectedIndex].text;
    var topicText = personalTopicSelect.options[personalTopicSelect.selectedIndex].text;
    
    document.getElementById('personalSelectedGradeName').textContent = gradeText;
    document.getElementById('personalSelectedSectionName').textContent = sectionText;
    document.getElementById('personalSelectedTopicName').textContent = topicText;
    document.getElementById('personalSelectedStudentsCount').textContent = selectedStudentIds.length;
    
    personalAssignmentSummary.style.display = 'block';
}

function hidePersonalAssignmentSummary() {
    personalAssignmentSummary.style.display = 'none';
}

function resetPersonalSelection() {
    personalSelectedGradeId = null;
    personalSelectedSectionId = null;
    personalSelectedTopicId = null;
    selectedStudentIds = [];
    resetPersonalSectionAndTopic();
}

function resetPersonalSectionAndTopic() {
    personalSelectedSectionId = null;
    personalSelectedTopicId = null;
    selectedStudentIds = [];
    personalSectionStep.style.display = 'none';
    resetPersonalTopicAndStudents();
}

function resetPersonalTopicAndStudents() {
    personalSelectedTopicId = null;
    selectedStudentIds = [];
    personalTopicStep.style.display = 'none';
    resetPersonalStudents();
}

function resetPersonalStudents() {
    selectedStudentIds = [];
    personalStudentsStep.style.display = 'none';
    hidePersonalAssignmentSummary();
    if (personalStudentsList) personalStudentsList.innerHTML = '';
    updateSelectedStudentsCount();
}

function showPersonalMessage(messageId) {
    hidePersonalMessages();
    var element = document.getElementById(messageId);
    if (element) element.style.display = 'block';
}

function hidePersonalMessages() {
    ['personalNoGradesMessage', 'personalNoSectionsMessage', 'personalNoTopicsMessage', 'noStudentsMessage'].forEach(id => {
        var element = document.getElementById(id);
        if (element) element.style.display = 'none';
    });
}

function checkAssignButtonState() {
    var canAssign = false;
    var helpText = '';
    
    if (selectedMaterialType === 'class') {
        canAssign = selectedGradeId && selectedSectionId && selectedCourseTopicId;
        if (!selectedGradeId) helpText = 'Selecciona un grado';
        else if (!selectedSectionId) helpText = 'Selecciona una sección';
        else if (!selectedCourseTopicId) helpText = 'Selecciona un tema del curso';
        else helpText = 'Listo para asignar a toda la clase';
    } else {
        canAssign = personalSelectedGradeId && personalSelectedSectionId && personalSelectedTopicId && selectedStudentIds.length > 0;
        if (!personalSelectedGradeId) helpText = 'Selecciona un grado';
        else if (!personalSelectedSectionId) helpText = 'Selecciona una sección';
        else if (!personalSelectedTopicId) helpText = 'Selecciona un tema';
        else if (selectedStudentIds.length === 0) helpText = 'Selecciona al menos un estudiante';
        else helpText = `Listo para asignar a ${selectedStudentIds.length} estudiante(s)`;
    }
    
    assignButton.disabled = !canAssign;
    var helpElement = document.getElementById('assignButtonHelp');
    if (helpElement) {
        helpElement.innerHTML = '<i class="fas fa-info-circle me-1"></i> ' + helpText;
    }
}
</script>
{% endblock %}
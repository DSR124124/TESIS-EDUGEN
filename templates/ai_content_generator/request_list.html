{% extends 'dashboard/teacher/base.html' %}
{% load static %}

{% block title %}Mis Solicitudes de Contenido IA{% endblock %}

{% block head_extra %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #005CFF;
        --primary-light: rgba(0, 92, 255, 0.1);
        --secondary-color: #A142F5;
        --accent-color: #00CFFF;
        --success-color: #10B981;
        --warning-color: #F59E0B;
        --danger-color: #EF4444;
        --light-gray: #f8f9fa;
        --medium-gray: #e9ecef;
        --dark-gray: #495057;
        --card-bg: #FFFFFF;
        --text-primary: #1F2937;
        --text-secondary: #6B7280;
        --border-radius: 12px;
        --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.15);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    .content-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Header del Dashboard Mejorado */
    .dashboard-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: var(--border-radius);
        padding: 30px;
        color: white;
        box-shadow: var(--shadow-lg);
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }

    .dashboard-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 300px;
        height: 100%;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" patternUnits="userSpaceOnUse" width="20" height="20"><circle cx="10" cy="10" r="2" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>') repeat;
        opacity: 0.3;
    }

    .stats-row {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: rgba(255, 255, 255, 0.15);
        padding: 15px 20px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: var(--transition);
    }

    .stat-item:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.2);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: white;
        margin-bottom: 5px;
        line-height: 1;
    }

    .stat-label {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .create-btn {
        background: linear-gradient(135deg, #FFD700, #FFA500);
        border: none;
        color: #1F2937;
        font-weight: 600;
        padding: 12px 24px;
        border-radius: 50px;
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        transition: var(--transition);
    }

    .create-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        color: #1F2937;
    }

    /* Filtros mejorados */
    .filters-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: var(--shadow-sm);
        margin-bottom: 25px;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .filter-container {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
    }

    .filter-left {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
    }

    .filter-right {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .view-toggle {
        display: flex;
        background: var(--light-gray);
        border-radius: 8px;
        padding: 4px;
        border: 1px solid var(--medium-gray);
    }

    .view-toggle-btn {
        padding: 8px 12px;
        border: none;
        background: transparent;
        border-radius: 6px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
    }

    .view-toggle-btn.active {
    background: white;
        color: var(--primary-color);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .items-per-page {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .items-per-page select {
        padding: 6px 10px;
        border: 1px solid var(--medium-gray);
        border-radius: 6px;
        background: white;
        font-size: 0.9rem;
    }

    .filter-btn {
        padding: 10px 20px;
        border-radius: 25px;
        border: 2px solid var(--medium-gray);
        background: white;
        color: var(--text-secondary);
        font-weight: 500;
        transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
        cursor: pointer;
    }

    .filter-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        transform: translateY(-1px);
    }

    .filter-btn.active {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-color: var(--primary-color);
        color: white;
        box-shadow: 0 4px 12px rgba(0, 92, 255, 0.3);
    }

    .filter-badge {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border-radius: 12px;
        padding: 4px 8px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .filter-btn:not(.active) .filter-badge {
        background: var(--light-gray);
        color: var(--text-secondary);
    }

    /* Cards mejoradas */
    .requests-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 24px;
        margin-bottom: 30px;
    }

    /* Vista de tabla compacta */
    .requests-table-view {
        display: none;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
    overflow: hidden;
        margin-bottom: 30px;
    }

    .requests-table {
        width: 100%;
        border-collapse: collapse;
    }

    .requests-table th {
        background: var(--light-gray);
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        color: var(--text-primary);
        border-bottom: 2px solid var(--medium-gray);
        font-size: 0.9rem;
    }

    .requests-table td {
        padding: 12px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        font-size: 0.9rem;
        vertical-align: middle;
    }

    .requests-table tr:hover {
        background: var(--light-gray);
    }

    .table-topic {
        font-weight: 600;
        color: var(--text-primary);
        max-width: 250px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .table-course {
        color: var(--primary-color);
        font-weight: 500;
    }

    .table-actions {
        display: flex;
        gap: 6px;
    }

    .table-action-btn {
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .btn-view {
        background: var(--primary-color);
        color: white;
    }

    .btn-delete {
        background: var(--danger-color);
        color: white;
    }

    .btn-cancel {
        background: var(--warning-color);
        color: white;
    }

    .btn-regenerate {
        background: var(--success-color);
        color: white;
    }

    .table-action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .request-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
        transition: var(--transition);
        border: 1px solid rgba(0, 0, 0, 0.05);
        position: relative;
    }

    .request-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }

    .card-status-indicator {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--medium-gray);
    }

    .card-status-indicator.completed { background: linear-gradient(90deg, var(--success-color), #34D399); }
    .card-status-indicator.pending { background: linear-gradient(90deg, var(--warning-color), #FBBF24); }
    .card-status-indicator.processing { background: linear-gradient(90deg, var(--accent-color), #06B6D4); }
    .card-status-indicator.failed { background: linear-gradient(90deg, var(--danger-color), #F87171); }
    .card-status-indicator.cancelled { background: linear-gradient(90deg, var(--dark-gray), #9CA3AF); }

    .card-header {
        padding: 20px 20px 0 20px;
    }

    .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .card-meta {
        display: flex;
        align-items: center;
        gap: 15px;
        color: var(--text-secondary);
        font-size: 0.85rem;
        margin-bottom: 15px;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .card-body {
        padding: 0 20px 20px 20px;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        margin-bottom: 15px;
    }

    .status-badge.completed {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .status-badge.pending {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
        border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .status-badge.processing {
        background: rgba(0, 207, 255, 0.1);
        color: var(--accent-color);
        border: 1px solid rgba(0, 207, 255, 0.2);
    }

    .status-badge.failed {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .status-badge.cancelled {
        background: rgba(107, 114, 128, 0.1);
        color: var(--dark-gray);
        border: 1px solid rgba(107, 114, 128, 0.2);
    }

    .card-actions {
        display: flex;
        gap: 10px;
    }

    .action-btn {
        flex: 1;
        padding: 10px 16px;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.9rem;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        border: none;
        cursor: pointer;
    }

    .action-btn-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
    }

    .action-btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 92, 255, 0.3);
    }

    .action-btn-danger {
        background: linear-gradient(135deg, var(--danger-color), #F87171);
        color: white;
    }

    .action-btn-danger:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .action-btn-secondary {
        background: var(--light-gray);
        color: var(--text-secondary);
        border: 1px solid var(--medium-gray);
    }

    .action-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    /* Estado vacío mejorado */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
        margin: 20px 0;
    }

    .empty-icon {
        font-size: 4rem;
        color: var(--primary-color);
        margin-bottom: 20px;
        opacity: 0.6;
    }

    .empty-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
    margin-bottom: 10px;
}

    .empty-description {
        color: var(--text-secondary);
    font-size: 1rem;
        line-height: 1.6;
        margin-bottom: 30px;
    }

    /* Animaciones */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .fa-spin {
        animation: spin 1s linear infinite;
    }

    .request-card {
        animation: fadeInUp 0.5s ease-out forwards;
    }

    .request-card:nth-child(1) { animation-delay: 0.1s; }
    .request-card:nth-child(2) { animation-delay: 0.2s; }
    .request-card:nth-child(3) { animation-delay: 0.3s; }
    .request-card:nth-child(4) { animation-delay: 0.4s; }
    .request-card:nth-child(5) { animation-delay: 0.5s; }
    .request-card:nth-child(6) { animation-delay: 0.6s; }

    /* Responsive */
    @media (max-width: 768px) {
        .content-container {
            padding: 15px;
        }

        .dashboard-header {
            padding: 20px;
            text-align: center;
        }

        .dashboard-header .row {
    flex-direction: column;
            gap: 20px;
}

        .stats-row {
    justify-content: center;
            flex-wrap: wrap;
        }

        .requests-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .filter-container {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }

        .filter-left {
            justify-content: center;
        }

        .filter-right {
            justify-content: center;
        }

        .card-actions {
            flex-direction: column;
        }

        /* Ocultar vista de tabla en móviles */
        .view-toggle-btn[data-view="table"] {
            display: none;
        }

        .requests-table-view {
            display: none !important;
        }

        .pagination-container {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }

        .pagination {
            justify-content: center;
            flex-wrap: wrap;
        }
    }

    @media (max-width: 480px) {
        .filter-left {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-btn {
            justify-content: space-between;
        }

        .stat-item {
            min-width: 100px;
        }

        .pagination-btn {
            padding: 6px 10px;
    font-size: 0.8rem;
        }
    }

    /* Notificaciones toast */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
    }

    .custom-toast {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        border: none;
        min-width: 350px;
        max-width: 500px;
    }

    .toast-success {
        border-left: 4px solid var(--success-color);
    }

    .toast-error {
        border-left: 4px solid var(--danger-color);
    }

    .toast-warning {
        border-left: 4px solid var(--warning-color);
    }



    /* Paginación */
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 30px;
        padding: 20px;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
    }

    .pagination-info {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .pagination {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .pagination-btn {
        padding: 8px 12px;
        border: 1px solid var(--medium-gray);
        background: white;
        color: var(--text-secondary);
        border-radius: 6px;
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.9rem;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .pagination-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        background: var(--primary-light);
    }

    .pagination-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-btn:disabled:hover {
        border-color: var(--medium-gray);
        color: var(--text-secondary);
        background: white;
    }

    .pagination-ellipsis {
        padding: 8px 4px;
        color: var(--text-secondary);
    }
}
</style>
{% endblock %}

{% block teacher_content %}
<div class="content-container">
    <!-- Header del Dashboard Mejorado -->
    <div class="dashboard-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2 fw-bold">
                    <i class="fas fa-robot me-3"></i>
                    Generador de Contenido IA
                </h1>
                <p class="mb-0 opacity-75 fs-5">Gestiona y visualiza tus solicitudes de contenido educativo generado por inteligencia artificial</p>
                
                <!-- Estadísticas rápidas -->
                <div class="stats-row">
                    <div class="stat-item">
                        <span class="stat-number" id="total-requests">{{ total_count }}</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="completed-requests">{{ completed_count }}</span>
                        <span class="stat-label">Completados</span>
                </div>
                    <div class="stat-item">
                        <span class="stat-number" id="pending-requests">{{ pending_count|add:processing_count }}</span>
                        <span class="stat-label">En Proceso</span>
            </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros Mejorados -->
    <div class="filters-card">
        <div class="filter-container">
            <div class="filter-left">
                <button class="filter-btn active" data-filter="all">
                    <i class="fas fa-list"></i>
                    Todos
                    <span class="filter-badge" id="count-all">{{ total_count }}</span>
                </button>
                <button class="filter-btn" data-filter="completed">
                    <i class="fas fa-check-circle"></i>
                    Completados
                    <span class="filter-badge" id="count-completed">{{ completed_count }}</span>
                </button>
                <button class="filter-btn" data-filter="processing">
                    <i class="fas fa-spinner"></i>
                    En Proceso
                    <span class="filter-badge" id="count-processing">{{ processing_count }}</span>
                </button>
                <button class="filter-btn" data-filter="pending">
                    <i class="fas fa-clock"></i>
                    Pendientes
                    <span class="filter-badge" id="count-pending">{{ pending_count }}</span>
                </button>
                <button class="filter-btn" data-filter="failed">
                    <i class="fas fa-exclamation-triangle"></i>
                    Fallidos
                    <span class="filter-badge" id="count-failed">{{ failed_count }}</span>
                </button>
            </div>
            <div class="filter-right">
                <div class="view-toggle">
                    <button class="view-toggle-btn active" data-view="grid">
                        <i class="fas fa-th"></i>
                        Tarjetas
                    </button>
                    <button class="view-toggle-btn" data-view="table">
                        <i class="fas fa-list"></i>
                        Tabla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido de solicitudes -->
    {% if requests %}
        <!-- Vista de Tarjetas -->
        <div class="requests-grid" id="grid-view">
                        {% for request in requests %}
            <div class="request-card" data-status="{{ request.status }}" data-request-id="{{ request.id }}">
                <div class="card-status-indicator {{ request.status }}"></div>
                
                <div class="card-header">
                    <h3 class="card-title">{{ request.topic }}</h3>
                    <div class="card-meta">
                        <div class="meta-item">
                            <i class="fas fa-book"></i>
                            <span>{{ request.course.name }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-graduation-cap"></i>
                            <span>{{ request.grade_level }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>{{ request.created_at|date:"d/m/Y H:i" }}</span>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <div class="status-badge {{ request.status }}" id="status-{{ request.id }}">
                                {% if request.status == 'pending' %}
                            <i class="fas fa-hourglass-start"></i>
                            Pendiente
                                {% elif request.status == 'processing' %}
                            <i class="fas fa-spinner fa-spin"></i>
                            En Proceso
                                {% elif request.status == 'completed' %}
                            <i class="fas fa-check-circle"></i>
                            Completado
                                {% elif request.status == 'failed' %}
                            <i class="fas fa-exclamation-triangle"></i>
                            Fallido
                                {% elif request.status == 'cancelled' %}
                            <i class="fas fa-ban"></i>
                            Cancelado
                                {% endif %}
                    </div>

                    <div class="card-actions" id="actions-{{ request.id }}">
                                {% if request.status == 'completed' %}
                                    {% if request.contents.first %}
                                <a href="{% url 'ai:content_detail' request.contents.first.id %}" class="action-btn action-btn-primary">
                                                <i class="fas fa-eye"></i>
                                    Ver Contenido
                                            </a>
                                <button class="action-btn action-btn-danger delete-btn" data-request-id="{{ request.id }}">
                                                <i class="fas fa-trash"></i>
                                    Eliminar
                                            </button>
                                    {% else %}
                                <button class="action-btn action-btn-secondary" disabled>
                                    <i class="fas fa-exclamation-circle"></i>
                                    No Disponible
                                </button>
                                <button class="action-btn action-btn-danger delete-btn" data-request-id="{{ request.id }}">
                                            <i class="fas fa-trash"></i>
                                    Eliminar
                                        </button>
                                    {% endif %}
                        {% elif request.status == 'processing' or request.status == 'pending' %}
                            <button class="action-btn action-btn-secondary" disabled>
                                <i class="fas fa-clock"></i>
                                Procesando...
                                    </button>
                            <button class="action-btn action-btn-danger cancel-btn" data-request-id="{{ request.id }}">
                                        <i class="fas fa-times"></i>
                                Cancelar
                                    </button>
                        {% elif request.status == 'failed' %}
                            <button class="action-btn action-btn-primary regenerate-btn" data-request-id="{{ request.id }}">
                                <i class="fas fa-redo"></i>
                                Reintentar
                            </button>
                            <button class="action-btn action-btn-danger delete-btn" data-request-id="{{ request.id }}">
                                        <i class="fas fa-trash"></i>
                                Eliminar
                            </button>
                        {% elif request.status == 'cancelled' %}
                            <button class="action-btn action-btn-primary regenerate-btn" data-request-id="{{ request.id }}">
                                <i class="fas fa-redo"></i>
                                Reintentar
                            </button>
                            <button class="action-btn action-btn-danger delete-btn" data-request-id="{{ request.id }}">
                                <i class="fas fa-trash"></i>
                                Eliminar
                                    </button>
                                {% endif %}
            </div>
        </div>
            </div>
            {% endfor %}
    </div>

        <!-- Vista de Tabla -->
        <div class="requests-table-view" id="table-view">
            <table class="requests-table">
                <thead>
                    <tr>
                        <th style="width: 35%;">Tema</th>
                        <th style="width: 15%;">Curso</th>
                        <th style="width: 10%;">Grado</th>
                        <th style="width: 12%;">Fecha</th>
                        <th style="width: 10%;">Estado</th>
                        <th style="width: 18%;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
        {% for request in requests %}
                    <tr data-status="{{ request.status }}" data-request-id="{{ request.id }}">
                        <td>
                            <div class="table-topic" title="{{ request.topic }}">
                                {{ request.topic }}
                            </div>
                        </td>
                        <td>
                            <span class="table-course">{{ request.course.name }}</span>
                        </td>
                        <td>{{ request.grade_level }}</td>
                        <td>{{ request.created_at|date:"d/m/Y" }}</td>
                        <td>
                            <div class="status-badge {{ request.status }}" style="margin-bottom: 0;">
                    {% if request.status == 'pending' %}
                                    <i class="fas fa-hourglass-start"></i>
                                    Pendiente
                    {% elif request.status == 'processing' %}
                                    <i class="fas fa-spinner fa-spin"></i>
                                    En Proceso
                    {% elif request.status == 'completed' %}
                                    <i class="fas fa-check-circle"></i>
                                    Completado
                    {% elif request.status == 'failed' %}
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Fallido
                    {% elif request.status == 'cancelled' %}
                                    <i class="fas fa-ban"></i>
                                    Cancelado
                    {% endif %}
                </div>
                        </td>
                        <td>
                            <div class="table-actions">
                    {% if request.status == 'completed' %}
                        {% if request.contents.first %}
                                        <a href="{% url 'ai:content_detail' request.contents.first.id %}" class="table-action-btn btn-view" title="Ver contenido">
                                            <i class="fas fa-eye"></i>
                        </a>
                                        <button class="table-action-btn btn-delete delete-btn" data-request-id="{{ request.id }}" title="Eliminar">
                                            <i class="fas fa-trash"></i>
                        </button>
                        {% else %}
                                        <button class="table-action-btn btn-delete delete-btn" data-request-id="{{ request.id }}" title="Eliminar">
                                            <i class="fas fa-trash"></i>
                        </button>
                        {% endif %}
                                {% elif request.status == 'processing' or request.status == 'pending' %}
                                    <button class="table-action-btn btn-cancel cancel-btn" data-request-id="{{ request.id }}" title="Cancelar">
                                        <i class="fas fa-times"></i>
                        </button>
                                {% elif request.status == 'failed' or request.status == 'cancelled' %}
                                    <button class="table-action-btn btn-regenerate regenerate-btn" data-request-id="{{ request.id }}" title="Reintentar">
                                        <i class="fas fa-redo"></i>
                        </button>
                                    <button class="table-action-btn btn-delete delete-btn" data-request-id="{{ request.id }}" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                        </button>
                    {% endif %}
                </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>

        <!-- Paginación -->
        {% if is_paginated %}
        <div class="pagination-container">
            <div class="pagination-info">
                Mostrando {{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ page_obj.paginator.count }} solicitudes
        </div>
            <div class="pagination">
                {% if page_obj.has_previous %}
                    <a href="?page=1" class="pagination-btn">
                        <i class="fas fa-angle-double-left"></i>
                        Primera
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}" class="pagination-btn">
                        <i class="fas fa-angle-left"></i>
                        Anterior
                    </a>
                {% else %}
                    <button class="pagination-btn" disabled>
                        <i class="fas fa-angle-double-left"></i>
                        Primera
                    </button>
                    <button class="pagination-btn" disabled>
                        <i class="fas fa-angle-left"></i>
                        Anterior
                    </button>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <span class="pagination-btn active">{{ num }}</span>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <a href="?page={{ num }}" class="pagination-btn">{{ num }}</a>
                    {% elif num == 1 %}
                        <a href="?page={{ num }}" class="pagination-btn">{{ num }}</a>
                        {% if page_obj.number > 4 %}
                            <span class="pagination-ellipsis">...</span>
                        {% endif %}
                    {% elif num == page_obj.paginator.num_pages %}
                        {% if page_obj.number < page_obj.paginator.num_pages|add:'-3' %}
                            <span class="pagination-ellipsis">...</span>
                        {% endif %}
                        <a href="?page={{ num }}" class="pagination-btn">{{ num }}</a>
                    {% endif %}
        {% endfor %}

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="pagination-btn">
                        Siguiente
                        <i class="fas fa-angle-right"></i>
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}" class="pagination-btn">
                        Última
                        <i class="fas fa-angle-double-right"></i>
                    </a>
    {% else %}
                    <button class="pagination-btn" disabled>
                        Siguiente
                        <i class="fas fa-angle-right"></i>
                    </button>
                    <button class="pagination-btn" disabled>
                        Última
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                {% endif %}
        </div>
    </div>
    {% endif %}
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-robot"></i>
</div>
            <h3 class="empty-title">No hay solicitudes de contenido IA</h3>
            <p class="empty-description">
                Aún no has realizado ninguna solicitud de contenido generado por IA.<br>
                ¡Crea tu primera solicitud y descubre el poder de la inteligencia artificial!
            </p>
            <a href="{% url 'ai:content_request_create' %}" class="action-btn action-btn-primary" style="display: inline-flex;">
                <i class="fas fa-magic"></i>
                Crear Mi Primera Solicitud
            </a>
        </div>
    {% endif %}



    <!-- Container para notificaciones -->
    <div class="toast-container" id="toastContainer"></div>
</div>

<!-- CSRF Token -->
{% csrf_token %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Variables globales
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let updateInterval;
    
    // Inicializar
    init();
    
    function init() {
        updateStatistics();
        attachEventListeners();
        startAutoUpdate();
        
        // Restaurar vista preferida
        const savedView = localStorage.getItem('ai-requests-view') || 'grid';
        if (savedView === 'table') {
            document.querySelector('[data-view="table"]').click();
        }
        
        // Verificar si hay parámetro de solicitud creada
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('request_created') === 'true') {
            showToast('Solicitud de contenido creada exitosamente. El contenido se está generando.', 'success');
            // Limpiar parámetro de la URL
            history.replaceState({}, '', window.location.pathname);
        }
    }
    
    function updateStatistics() {
        const cards = document.querySelectorAll('.request-card:not([style*="display: none"])');
        const stats = {
            total: cards.length,
            completed: 0,
            processing: 0,
            pending: 0,
            failed: 0,
            cancelled: 0
        };
        
        cards.forEach(card => {
            const status = card.getAttribute('data-status');
            if (stats.hasOwnProperty(status)) {
                stats[status]++;
            }
        });
        
        // Actualizar números en estadísticas del header
        document.getElementById('total-requests').textContent = stats.total;
        document.getElementById('completed-requests').textContent = stats.completed;
        document.getElementById('pending-requests').textContent = stats.processing + stats.pending;
        
        // Actualizar badges en filtros
        document.getElementById('count-all').textContent = stats.total;
        document.getElementById('count-completed').textContent = stats.completed;
        document.getElementById('count-processing').textContent = stats.processing;
        document.getElementById('count-pending').textContent = stats.pending;
        document.getElementById('count-failed').textContent = stats.failed;
    }
    
    function attachEventListeners() {
        // Filtros
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', handleFilterClick);
        });
        
        // Toggle de vista
        document.querySelectorAll('.view-toggle-btn').forEach(btn => {
            btn.addEventListener('click', handleViewToggle);
        });
        
        // Botones de eliminar
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', handleDelete);
        });
        
        // Botones de cancelar
        document.querySelectorAll('.cancel-btn').forEach(btn => {
            btn.addEventListener('click', handleCancel);
        });
        
        // Botones de regenerar
        document.querySelectorAll('.regenerate-btn').forEach(btn => {
            btn.addEventListener('click', handleRegenerate);
        });
    }
    
    function handleViewToggle(e) {
        const view = e.currentTarget.getAttribute('data-view');
        
        // Actualizar botones activos
        document.querySelectorAll('.view-toggle-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        e.currentTarget.classList.add('active');
        
        // Mostrar/ocultar vistas
        const gridView = document.getElementById('grid-view');
        const tableView = document.getElementById('table-view');
        
        if (view === 'grid') {
            gridView.style.display = 'grid';
            tableView.style.display = 'none';
        } else {
            gridView.style.display = 'none';
            tableView.style.display = 'block';
        }
        
        // Guardar preferencia en localStorage
        localStorage.setItem('ai-requests-view', view);
    }
    
    function handleFilterClick(e) {
        const filter = e.currentTarget.getAttribute('data-filter');
        
        // Actualizar botones activos
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        e.currentTarget.classList.add('active');
        
        // Filtrar cards (vista grid)
        document.querySelectorAll('.request-card').forEach(card => {
            const status = card.getAttribute('data-status');
            const shouldShow = filter === 'all' || status === filter;
            
            if (shouldShow) {
                card.style.display = 'block';
                card.style.animation = 'fadeInUp 0.5s ease-out';
            } else {
                card.style.display = 'none';
            }
        });
        
        // Filtrar filas (vista tabla)
        document.querySelectorAll('.requests-table tbody tr').forEach(row => {
                const status = row.getAttribute('data-status');
            const shouldShow = filter === 'all' || status === filter;
            
            if (shouldShow) {
                row.style.display = 'table-row';
            } else {
                row.style.display = 'none';
            }
        });
        
        // Actualizar estadísticas
        updateStatistics();
    }
    
    function handleDelete(e) {
        const requestId = e.currentTarget.getAttribute('data-request-id');
        
        if (!confirm('¿Estás seguro de que deseas eliminar esta solicitud? Esta acción no se puede deshacer.')) {
                    return;
                }
                
        const btn = e.currentTarget;
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
        btn.disabled = true;
        
        fetch(`/ai/requests/delete/${requestId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Animar y eliminar la card
                const card = document.querySelector(`[data-request-id="${requestId}"]`);
                if (card) {
                    card.style.transition = 'all 0.5s ease';
                    card.style.transform = 'translateX(-100%)';
                    card.style.opacity = '0';
                    
            setTimeout(() => {
                        card.remove();
                        updateStatistics();
                        checkEmptyState();
                    }, 500);
                }
                
                showToast('Solicitud eliminada exitosamente', 'success');
            } else {
                showToast(data.message || 'Error al eliminar la solicitud', 'error');
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error de conexión al eliminar la solicitud', 'error');
            btn.innerHTML = originalContent;
            btn.disabled = false;
        });
    }
    
    function handleCancel(e) {
        const requestId = e.currentTarget.getAttribute('data-request-id');
        
        if (!confirm('¿Estás seguro de que deseas cancelar esta solicitud?')) {
                return;
            }
            
        const btn = e.currentTarget;
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cancelando...';
        btn.disabled = true;
        
            fetch(`/ai/cancel/${requestId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
        .then(response => response.json())
            .then(data => {
                if (data.success) {
                // Actualizar estado de la card
                updateCardStatus(requestId, 'cancelled');
                showToast('Solicitud cancelada exitosamente', 'success');
                } else {
                showToast(data.message || 'Error al cancelar la solicitud', 'error');
                btn.innerHTML = originalContent;
                btn.disabled = false;
                }
            })
            .catch(error => {
            console.error('Error:', error);
            showToast('Error de conexión al cancelar la solicitud', 'error');
            btn.innerHTML = originalContent;
            btn.disabled = false;
        });
    }
    
    function handleRegenerate(e) {
        const requestId = e.currentTarget.getAttribute('data-request-id');
        
        const btn = e.currentTarget;
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Regenerando...';
        btn.disabled = true;
        
        fetch(`/ai/regenerate/${requestId}/`, {
            method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
        .then(response => response.json())
            .then(data => {
                if (data.success) {
                // Actualizar estado de la card
                updateCardStatus(requestId, 'processing');
                showToast('Regeneración iniciada exitosamente', 'success');
                } else {
                showToast(data.message || 'Error al regenerar la solicitud', 'error');
                btn.innerHTML = originalContent;
                btn.disabled = false;
                }
            })
            .catch(error => {
            console.error('Error:', error);
            showToast('Error de conexión al regenerar la solicitud', 'error');
            btn.innerHTML = originalContent;
            btn.disabled = false;
        });
    }
    
    function updateCardStatus(requestId, newStatus) {
        const card = document.querySelector(`[data-request-id="${requestId}"]`);
        if (!card) return;
        
        // Actualizar atributo de estado
        card.setAttribute('data-status', newStatus);
        
        // Actualizar indicador visual
        const indicator = card.querySelector('.card-status-indicator');
        indicator.className = `card-status-indicator ${newStatus}`;
        
        // Actualizar badge de estado
        const statusBadge = card.querySelector('.status-badge');
        statusBadge.className = `status-badge ${newStatus}`;
        
        let statusContent = '';
        switch(newStatus) {
            case 'pending':
                statusContent = '<i class="fas fa-hourglass-start"></i> Pendiente';
                break;
            case 'processing':
                statusContent = '<i class="fas fa-spinner fa-spin"></i> En Proceso';
                break;
            case 'completed':
                statusContent = '<i class="fas fa-check-circle"></i> Completado';
                break;
            case 'failed':
                statusContent = '<i class="fas fa-exclamation-triangle"></i> Fallido';
                break;
            case 'cancelled':
                statusContent = '<i class="fas fa-ban"></i> Cancelado';
                break;
        }
        statusBadge.innerHTML = statusContent;
        
        // Actualizar acciones
        updateCardActions(requestId, newStatus);
        
        // Actualizar estadísticas
        updateStatistics();
    }
    
    function updateCardActions(requestId, status) {
        const actionsContainer = document.getElementById(`actions-${requestId}`);
        if (!actionsContainer) return;
        
        let actionsHTML = '';
        
        switch(status) {
            case 'completed':
                actionsHTML = `
                    <a href="/ai/contents/${requestId}/" class="action-btn action-btn-primary">
                        <i class="fas fa-eye"></i>
                        Ver Contenido
                    </a>
                    <button class="action-btn action-btn-danger delete-btn" data-request-id="${requestId}">
                        <i class="fas fa-trash"></i>
                        Eliminar
                    </button>
                `;
                break;
            case 'processing':
            case 'pending':
                actionsHTML = `
                    <button class="action-btn action-btn-secondary" disabled>
                        <i class="fas fa-clock"></i>
                        Procesando...
                    </button>
                    <button class="action-btn action-btn-danger cancel-btn" data-request-id="${requestId}">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                `;
                break;
            case 'failed':
            case 'cancelled':
                actionsHTML = `
                    <button class="action-btn action-btn-primary regenerate-btn" data-request-id="${requestId}">
                        <i class="fas fa-redo"></i>
                        Reintentar
                    </button>
                    <button class="action-btn action-btn-danger delete-btn" data-request-id="${requestId}">
                        <i class="fas fa-trash"></i>
                        Eliminar
                    </button>
                `;
                break;
        }
        
        actionsContainer.innerHTML = actionsHTML;
        
        // Reattach event listeners
        actionsContainer.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', handleDelete);
        });
        actionsContainer.querySelectorAll('.cancel-btn').forEach(btn => {
            btn.addEventListener('click', handleCancel);
        });
        actionsContainer.querySelectorAll('.regenerate-btn').forEach(btn => {
            btn.addEventListener('click', handleRegenerate);
        });
    }
    
    function startAutoUpdate() {
        updateInterval = setInterval(() => {
            // Verificar progreso de solicitudes en proceso, pero evitar las que están siendo monitoreadas
            const processingCards = document.querySelectorAll('[data-status="processing"], [data-status="pending"]');
            const monitoringRequestId = localStorage.getItem('monitoring_content_request');
            
            processingCards.forEach(card => {
                const requestId = card.getAttribute('data-request-id');
                
                // No actualizar la card que está siendo monitoreada por nuestro sistema de notificaciones
                if (requestId === monitoringRequestId) {
                    return;
                }
                
                fetch(`/ai/progress/${requestId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status !== card.getAttribute('data-status')) {
                        updateCardStatus(requestId, data.status);
                    }
                })
                .catch(error => {
                    console.error('Error checking progress:', error);
                });
            });
        }, 15000); // Actualizar cada 15 segundos (menos frecuente para evitar conflictos)
    }
    
    function checkEmptyState() {
        const cards = document.querySelectorAll('.request-card');
        const container = document.getElementById('requests-container');
        
        if (cards.length === 0) {
            container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i class="fas fa-robot"></i>
                                </div>
                    <h3 class="empty-title">No hay solicitudes de contenido IA</h3>
                    <p class="empty-description">
                        Todas las solicitudes han sido eliminadas.<br>
                        ¡Crea una nueva solicitud y descubre el poder de la inteligencia artificial!
                    </p>
                    <a href="{% url 'ai:content_request_create' %}" class="action-btn action-btn-primary" style="display: inline-flex;">
                        <i class="fas fa-magic"></i>
                        Crear Nueva Solicitud
                    </a>
                            </div>
            `;
        }
    }
    
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        const toastId = 'toast-' + Date.now();
        
        toast.className = `custom-toast toast-${type}`;
        toast.id = toastId;
        toast.innerHTML = `
            <div class="toast-header">
                <strong class="me-auto">
                    ${type === 'success' ? '<i class="fas fa-check-circle text-success"></i>' : 
                      type === 'error' ? '<i class="fas fa-exclamation-circle text-danger"></i>' : 
                      '<i class="fas fa-info-circle text-info"></i>'}
                    ${type === 'success' ? 'Éxito' : type === 'error' ? 'Error' : 'Información'}
                </strong>
                <button type="button" class="btn-close" onclick="document.getElementById('${toastId}').remove()"></button>
                            </div>
            <div class="toast-body">
                ${message}
                </div>
            `;
            
        container.appendChild(toast);
        
        // Auto-eliminar después de 5 segundos
        setTimeout(() => {
            if (document.getElementById(toastId)) {
                document.getElementById(toastId).remove();
            }
        }, 5000);
    }
    
    // Monitoreo de contenido recién generado
    let notificationShown = false; // Flag para evitar notificaciones duplicadas
    
    function checkContentStatus(requestId) {
        const checkStatus = () => {
            fetch(`/ai/api/check-content-status/${requestId}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed' && !notificationShown) {
                    // Contenido listo - mostrar notificación solo una vez
                    notificationShown = true;
                    showContentReadyNotification(data.content_url, data.content_title);
                    localStorage.removeItem('monitoring_content_request');
                    
                } else if (data.status === 'failed' || data.status === 'cancelled') {
                    // Error o cancelado
                    if (!notificationShown) {
                        showToast(data.message, 'error');
                        notificationShown = true;
                    }
                    localStorage.removeItem('monitoring_content_request');
                    
                } else if (data.status === 'processing') {
                    // Seguir monitoreando solo si no se ha mostrado notificación
                    if (!notificationShown) {
                        setTimeout(checkStatus, 5000); // Verificar cada 5 segundos
                    }
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
                // Seguir intentando en caso de error de red solo si no se ha mostrado notificación
                if (!notificationShown) {
                    setTimeout(checkStatus, 10000);
                }
            });
        };
        
        checkStatus();
    }
    
    function showContentReadyNotification(contentUrl, contentTitle) {
        // Verificar si ya existe una notificación para evitar duplicados
        const existingNotification = document.querySelector('.content-ready-notification');
        if (existingNotification) {
            return; // Ya hay una notificación visible
        }
        
        // Crear notificación especial con botón de acción
        const notification = document.createElement('div');
        notification.className = 'alert alert-success alert-dismissible fade show position-fixed content-ready-notification';
        notification.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 1060;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 12px;
            border: 1px solid var(--success-color);
            background: rgba(16, 185, 129, 0.1);
        `;
        
        notification.innerHTML = `
            <div class="d-flex align-items-center mb-2">
                <i class="fas fa-check-circle text-success me-2" style="font-size: 1.2rem;"></i>
                <div class="flex-grow-1">
                    <strong style="color: var(--success-color);">¡Contenido listo!</strong><br>
                    <small class="text-muted">${contentTitle || 'Su contenido'} está disponible</small>
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="${contentUrl}" class="btn btn-success btn-sm">
                    <i class="fas fa-eye me-1"></i>Ver contenido
                </a>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="closeContentNotification(this)">
                    Cerrar
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remover después de 20 segundos
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 20000);
        
        // También mostrar un toast regular (solo una vez)
        showToast('Su contenido ya está listo, puede ir a revisarlo', 'success');
    }
    
    // Función para cerrar notificación y evitar que vuelva a aparecer
    window.closeContentNotification = function(button) {
        const notification = button.closest('.alert');
        if (notification) {
            notification.remove();
        }
        // Marcar que la notificación fue cerrada manualmente
        notificationShown = true;
        localStorage.removeItem('monitoring_content_request');
        
        // También limpiar cualquier toast relacionado
        const toasts = document.querySelectorAll('.custom-toast');
        toasts.forEach(toast => {
            if (toast.textContent.includes('contenido ya está listo')) {
                toast.remove();
            }
        });
    }
    
    // Función para limpiar completamente el monitoreo
    function clearContentMonitoring() {
        notificationShown = true;
        localStorage.removeItem('monitoring_content_request');
        
        // Remover notificaciones existentes
        const existingNotifications = document.querySelectorAll('.content-ready-notification');
        existingNotifications.forEach(notification => notification.remove());
    }
    
    // Verificar si hay contenido siendo monitoreado al cargar la página
    const monitoringRequestId = localStorage.getItem('monitoring_content_request');
    if (monitoringRequestId && !notificationShown) {
        checkContentStatus(monitoringRequestId);
    }

    // Cleanup al salir de la página
    window.addEventListener('beforeunload', () => {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    });
    });
</script>
{% endblock %} 
{% extends 'dashboard/teacher/base.html' %}
{% load static %}

{% block title %}Solicitud de Contenido{% endblock %}

{% block teacher_content %}
<div class="content-container">
    <!-- Mensajes flotantes -->
    {% include 'partials/_messages.html' %}

    <!-- Breadcrumb Navigation -->
    <nav class="dashboard-breadcrumb" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'dashboard:teacher' %}" class="breadcrumb-link">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            {% if from_course_dashboard and course_topic %}
                <li class="breadcrumb-item">
                    <a href="{% url 'dashboard:teacher_sections' %}" class="breadcrumb-link">
                        <i class="fas fa-users"></i>
                        <span>Mis Secciones</span>
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'dashboard:teacher_section_detail' section.id %}" class="breadcrumb-link">
                        <i class="fas fa-door-open"></i>
                        <span>{{ section.grade.name }} - Secci√≥n {{ section.name }}</span>
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'dashboard:course_topic_detail' pk=course_topic.id %}" class="breadcrumb-link">
                        <i class="fas fa-book-open"></i>
                        <span>{{ course_topic.title }}</span>
                    </a>
                </li>
            {% else %}
                <li class="breadcrumb-item">
                    <a href="{% url 'ai:content_request_list' %}" class="breadcrumb-link">
                        <i class="fas fa-robot"></i>
                        <span>Contenido IA</span>
                    </a>
                </li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">
                <i class="fas fa-magic"></i>
                <span>Generar Contenido</span>
            </li>
        </ol>
    </nav>

    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                {% if from_course_dashboard and course_topic %}
                    <h2 class="mb-1">‚ú® Generar Material para Clase</h2>
                    <p class="mb-0">{{ course_topic.title }} - {{ course_name }} ({{ section_name }})</p>
                    <small class="text-muted">{{ students_count }} estudiante{{ students_count|pluralize:"s" }} recibir√°{{ students_count|pluralize:"n," }} este contenido</small>
                {% else %}
                    <h2 class="mb-1">‚ú® Crear Contenido con IA</h2>
                    <p class="mb-0">Genera material educativo personalizado de forma r√°pida y sencilla</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="container py-4">

        <div class="portfolio-card animated-card">
            <div class="portfolio-header">
                <h5 class="mb-0"><i class="fas fa-robot me-2"></i> Asistente de Creaci√≥n de Contenido</h5>
            </div>
            <div class="portfolio-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i> Por favor corrige los siguientes errores:</h5>
                        <ul class="mb-0">
                            {% for field in form %}
                                {% for error in field.errors %}
                                    <li>{{ field.label }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    {% if from_course_dashboard and course_topic %}
                        <!-- Informaci√≥n prellenada desde course-topic -->
                        <div class="alert alert-success mb-4 d-flex align-items-center">
                            <i class="fas fa-check-circle text-success me-3" style="font-size: 1.5rem;"></i>
                            <div>
                                <strong>Informaci√≥n del tema cargada autom√°ticamente.</strong> 
                                Los campos ya est√°n configurados para el tema "{{ course_topic.title }}".
                            </div>
                        </div>
                        
                        <!-- Selector de secciones para asignaci√≥n -->
                        <div class="card mt-4 border-0 bg-light">
                            <div class="card-body">
                                <h5 class="d-flex align-items-center text-primary mb-3">
                                    <i class="fas fa-chalkboard me-2"></i>
                                    <span>Asignaci√≥n por Secciones</span>
                                </h5>
                                
                                <div class="alert alert-info mb-3">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-info-circle me-2 mt-1"></i>
                                        <div>
                                            <strong>Asignaci√≥n Flexible:</strong> Puedes asignar este material a m√∫ltiples secciones del mismo grado.
                                            <br><small class="text-muted">Selecciona las secciones donde quieres que aparezca este material.</small>
                                        </div>
                                    </div>
                                </div>
                                
                                {% if available_sections %}
                                <div class="form-group">
                                    <label class="form-label mb-3">
                                        <i class="fas fa-check-square me-2"></i>
                                        Seleccionar Secciones ({{ section.grade.name }})
                                    </label>
                                    
                                    <div class="section-selector">
                                        <div class="row g-3">
                                            {% for avail_section in available_sections %}
                                            <div class="col-md-6">
                                                <div class="form-check section-check-card">
                                                    <input class="form-check-input section-checkbox" 
                                                           type="checkbox" 
                                                           value="{{ avail_section.id }}" 
                                                           id="section_{{ avail_section.id }}"
                                                           name="target_sections"
                                                           {% if avail_section.id == section.id %}checked{% endif %}>
                                                    <label class="form-check-label section-check-label" for="section_{{ avail_section.id }}">
                                                        <div class="section-info">
                                                            <div class="section-name">
                                                                <i class="fas fa-chalkboard me-2"></i>
                                                                SECCI√ìN {{ avail_section.name }}
                                                            </div>
                                                            <small class="text-muted">
                                                                <i class="fas fa-users me-1"></i>
                                                                {{ avail_section.current_students|default:0 }} estudiantes
                                                            </small>
                                                        </div>
                                                    </label>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="fas fa-lightbulb me-1"></i>
                                            <strong>Sugerencia:</strong> La secci√≥n actual ({{ section.name }}) est√° preseleccionada. 
                                            Puedes agregar o quitar otras secciones seg√∫n necesites.
                                        </small>
                                    </div>
                                </div>
                                {% else %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Solo tienes asignada una secci√≥n para este grado. El material se asignar√° autom√°ticamente a la secci√≥n {{ section.name }}.
                                </div>
                                <input type="hidden" name="target_sections" value="{{ section.id }}">
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Campos ocultos para informaci√≥n prellenada -->
                        {{ form.course.as_hidden }}
                        {{ form.topic.as_hidden }}
                        {{ form.grade_level.as_hidden }}
                        
                        <!-- Solo mostrar el tipo de contenido -->
                        <div class="row g-4 mt-3">
                            <div class="col-12">
                                <div class="form-group required-field position-relative">
                                    <label for="{{ form.content_type.id_for_label }}" class="form-label">
                                        <i class="fas fa-file-alt me-2 text-primary"></i> {{ form.content_type.label }}
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0">
                                            <i class="fas fa-list-alt text-primary"></i>
                                        </span>
                                        {{ form.content_type }}
                                    </div>
                                    {% if form.content_type.help_text %}
                                    <div class="form-text text-muted mt-1">
                                        <i class="fas fa-info-circle me-1"></i> {{ form.content_type.help_text }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <!-- Formulario completo para acceso directo -->
                        <div class="alert alert-info mb-4 d-flex align-items-center">
                            <i class="fas fa-lightbulb text-primary me-3" style="font-size: 1.5rem;"></i>
                            <div>
                                <strong>Consejo:</strong> Cuanto m√°s espec√≠fico seas en tu solicitud, mejores resultados obtendr√°s.
                            </div>
                        </div>
                        
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="form-group required-field position-relative">
                                    <label for="{{ form.course.id_for_label }}" class="form-label">
                                        <i class="fas fa-book me-2 text-primary"></i> {{ form.course.label }}
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0">
                                            <i class="fas fa-graduation-cap text-primary"></i>
                                        </span>
                                        {{ form.course }}
                                    </div>
                                    {% if form.course.help_text %}
                                    <div class="form-text text-muted mt-1">
                                        <i class="fas fa-info-circle me-1"></i> {{ form.course.help_text }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group required-field position-relative">
                                    <label for="{{ form.content_type.id_for_label }}" class="form-label">
                                        <i class="fas fa-file-alt me-2 text-primary"></i> {{ form.content_type.label }}
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0">
                                            <i class="fas fa-list-alt text-primary"></i>
                                        </span>
                                        {{ form.content_type }}
                                    </div>
                                    {% if form.content_type.help_text %}
                                    <div class="form-text text-muted mt-1">
                                        <i class="fas fa-info-circle me-1"></i> {{ form.content_type.help_text }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-4 mt-2">
                            <div class="col-md-8">
                                <div class="form-group required-field position-relative">
                                    <label for="{{ form.topic.id_for_label }}" class="form-label">
                                        <i class="fas fa-tags me-2 text-primary"></i> {{ form.topic.label }}
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0">
                                            <i class="fas fa-search text-primary"></i>
                                        </span>
                                        {{ form.topic }}
                                    </div>
                                    {% if form.topic.help_text %}
                                    <div class="form-text text-muted mt-1">
                                        <i class="fas fa-info-circle me-1"></i> {{ form.topic.help_text }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-group required-field position-relative">
                                    <label for="{{ form.grade_level.id_for_label }}" class="form-label">
                                        <i class="fas fa-user-graduate me-2 text-primary"></i> {{ form.grade_level.label }}
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0">
                                            <i class="fas fa-sort text-primary"></i>
                                        </span>
                                        {{ form.grade_level }}
                                    </div>
                                    {% if form.grade_level.help_text %}
                                    <div class="form-text text-muted mt-1">
                                        <i class="fas fa-info-circle me-1"></i> {{ form.grade_level.help_text }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <div class="card mt-4 border-0 bg-light">
                        <div class="card-body">
                            <h5 class="d-flex align-items-center text-primary mb-3">
                                <i class="fas fa-file-pdf me-2 text-primary"></i>
                                <span>Documentos de Apoyo</span>
                            </h5>
                            
                            <div class="form-group">
                                <label for="{{ form.pdf_file.id_for_label }}" class="form-label mb-2">
                                    <i class="fas fa-file-upload me-2 text-primary"></i> {{ form.pdf_file.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.pdf_file }}
                                </div>
                                <div class="form-text text-muted mt-2">
                                    <i class="fas fa-info-circle me-1"></i> Sube un PDF (ex√°menes, resultados, plan de estudio, etc.) para analizarlo e incorporar la informaci√≥n en la generaci√≥n de contenido.
                                </div>
                            </div>
                            
                            <!-- Previsualizaci√≥n del PDF -->
                            <div id="pdf-preview-container" class="mt-3 d-none">
                                <div class="card border-primary border-opacity-25">
                                    <div class="card-header bg-primary bg-opacity-10 py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0 text-primary">
                                                <i class="fas fa-file-pdf me-2"></i>
                                                <span id="pdf-filename">Documento seleccionado</span>
                                            </h6>
                                            <div>
                                                <button type="button" id="pdf-preview-toggle" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye me-1"></i> Ver documento
                                                </button>
                                                <button type="button" id="pdf-preview-close" class="btn btn-sm btn-outline-danger ms-2">
                                                    <i class="fas fa-times me-1"></i> Quitar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="pdf-preview-content" class="card-body p-0 d-none" style="height: 400px; overflow: hidden;">
                                        <iframe id="pdf-preview-iframe" style="width: 100%; height: 100%; border: none;"></iframe>
                                    </div>
                                    <div class="card-footer bg-light py-2 d-flex align-items-center">
                                        <i class="fas fa-info-circle text-primary me-2"></i>
                                        <small id="pdf-filesize" class="text-muted">Tama√±o: --</small>
                                        <span class="mx-2">|</span>
                                        <small id="pdf-pages" class="text-muted">P√°ginas: --</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group mt-4">
                        <label for="{{ form.additional_instructions.id_for_label }}" class="form-label">
                            <i class="fas fa-edit me-2 text-primary"></i> Instrucciones Adicionales
                        </label>
                        {{ form.additional_instructions }}
                        <div class="form-text text-muted mt-1">
                            <i class="fas fa-info-circle me-1"></i> Proporciona cualquier informaci√≥n adicional que quieras incluir en el contenido generado.
                        </div>
                    </div>
                    
                    <!-- Campos ocultos -->
                    {{ form.topic_id }}
                    
                    <div class="card bg-warning bg-opacity-10 border-0 my-4">
                        <div class="card-body">
                            <h6 class="mb-3"><i class="fas fa-lightbulb me-2 text-warning"></i> Consejos para mejores resultados</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="mb-0 ps-3">
                                        <li class="mb-2"><strong>S√© espec√≠fico</strong> con el tema y el nivel educativo</li>
                                        <li class="mb-2"><strong>Incluye objetivos de aprendizaje</strong> claros en las instrucciones</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="mb-0 ps-3">
                                        <li class="mb-2"><strong>Menciona habilidades clave</strong> que deseas reforzar</li>
                                        <li class="mb-2"><strong>Indica preferencias de formato</strong> y estructura</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if portfolio_topic %}
                    <div class="form-check mb-4">
                        <input type="checkbox" name="add_to_portfolio" id="id_add_to_portfolio" class="form-check-input" {% if form.add_to_portfolio.value %}checked{% endif %}>
                        <label for="id_add_to_portfolio" class="form-check-label">
                            <i class="fas fa-folder-plus me-2 text-primary"></i> Agregar autom√°ticamente al portafolio cuando est√© listo
                        </label>
                        <div class="form-text text-muted mt-1">
                            <i class="fas fa-info-circle me-1"></i> Si est√° desactivado, el contenido solo se generar√° y podr√°s agregarlo manualmente m√°s tarde.
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="mt-4 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            {% if from_course_dashboard and course_topic %}
                                <a href="{% url 'dashboard:course_topic_detail' pk=course_topic.id %}" class="btn btn-outline-secondary me-2">
                                    <i class="fas fa-arrow-left me-1"></i> Volver al Tema
                                </a>
                            {% else %}
                                <a href="{% url 'ai:content_request_list' %}" class="btn btn-outline-secondary me-2">
                                    <i class="fas fa-arrow-left me-1"></i> Volver
                                </a>
                            {% endif %}
                        </div>


                        <div class="d-flex">
                            {% if not from_course_dashboard %}
                                <a href="{% url 'ai:content_request_list' %}" class="btn btn-outline-custom me-2">
                                    <i class="fas fa-times me-1"></i> Cancelar
                                </a>
                            {% endif %}
                            <button type="submit" class="btn btn-primary-custom">
                                <i class="fas fa-robot me-1"></i> 
                                {% if from_course_dashboard and course_topic %}
                                    Generar para Clase con IA Optimizada
                                {% else %}
                                    Generar Contenido Optimizado
                                {% endif %}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    /* Variables CSS para consistencia */
    :root {
        --primary-color: #005cff;
        --secondary-color: #f8f9fa;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
        --text-primary: #2c3e50;
        --text-secondary: #6c757d;
        --border-color: #e9ecef;
        --hover-color: #0056e0;
        --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.1);
        --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.15);
        --border-radius: 12px;
        --transition: all 0.3s ease;
    }

    /* Breadcrumb Navigation */
    .dashboard-breadcrumb {
        margin-bottom: 2rem;
        padding: 0;
    }

    .breadcrumb {
        background: none;
        padding: 0;
        margin: 0;
        font-size: 0.9rem;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "‚Ä∫";
        color: var(--text-secondary);
        font-weight: 600;
        margin: 0 0.75rem;
    }

    .breadcrumb-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        text-decoration: none;
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        transition: var(--transition);
        font-weight: 500;
    }

    .breadcrumb-link:hover {
        color: var(--primary-color);
        background-color: rgba(0, 92, 255, 0.1);
        text-decoration: none;
    }

    .breadcrumb-item.active {
        color: var(--primary-color);
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Dashboard Header */
    .dashboard-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, #0056e0 100%);
        color: white;
        padding: 2rem;
        border-radius: var(--border-radius);
        margin-bottom: 2rem;
        box-shadow: var(--shadow-medium);
    }

    .dashboard-header h2 {
        font-weight: 700;
        font-size: 1.75rem;
        margin-bottom: 0.5rem;
    }

    .dashboard-header p {
        opacity: 0.9;
        font-size: 1rem;
        margin-bottom: 0;
    }

    .dashboard-header small {
        opacity: 0.8;
        font-size: 0.875rem;
    }

    /* Content Container */
    .content-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    /* Estilos espec√≠ficos para la p√°gina de solicitud de contenido */
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(0, 92, 255, 0.15);
    }
    
    .form-group {
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .form-group:hover {
        transform: translateY(-2px);
    }
    
    .form-control, .form-select {
        padding: 0.7rem 1rem;
        border-radius: 8px;
    }
    
    .input-group-text {
        border-radius: 8px 0 0 8px;
    }
    
    /* Animaci√≥n para el bot√≥n */
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(0, 92, 255, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(0, 92, 255, 0); }
        100% { box-shadow: 0 0 0 0 rgba(0, 92, 255, 0); }
    }
    
    .btn-primary-custom {
        background: linear-gradient(135deg, var(--primary-color) 0%, #0056e0 100%);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        animation: pulse 2s infinite;
        cursor: pointer;
    }
    
    .btn-primary-custom:hover {
        background: linear-gradient(135deg, #0056e0 0%, #004bb3 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 92, 255, 0.3);
        color: white;
    }
    
    .btn-primary-custom:focus {
        outline: none;
        box-shadow: 0 0 0 0.25rem rgba(0, 92, 255, 0.25);
        color: white;
    }
    
    .btn-primary-custom:active {
        transform: translateY(0);
        background: linear-gradient(135deg, #004bb3 0%, #003d8a 100%);
        color: white;
    }
    
    .btn-outline-custom {
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        background: transparent;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .btn-outline-custom:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 92, 255, 0.3);
    }

    /* PDF Viewer styles */
    #pdf-preview-container iframe {
        width: 100%;
        height: 100%;
        border: none;
    }
    
    /* Progress bar styles */
    .progress-container {
        margin-top: 20px;
    }
    
    .progress {
        height: 25px;
        margin-bottom: 10px;
    }
    
    .progress-bar {
        transition: width 0.3s ease;
    }
    
    .progress-text {
        font-size: 0.9rem;
        text-align: center;
        margin-bottom: 10px;
        color: #666;
    }
    
    /* Section selector styles */
    .section-selector {
        margin-bottom: 1rem;
    }
    
    .section-check-card {
        background: white;
        border: 2px solid #e3e6f0;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .section-check-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(0, 92, 255, 0.05), rgba(161, 66, 245, 0.05));
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .section-check-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 92, 255, 0.15);
    }
    
    .section-check-card:hover::before {
        opacity: 1;
    }
    
    .section-checkbox:checked + .section-check-label .section-check-card {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, rgba(0, 92, 255, 0.1), rgba(161, 66, 245, 0.1));
    }
    
    .section-checkbox {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 20px;
        height: 20px;
        z-index: 2;
    }
    
    .section-check-label {
        cursor: pointer;
        margin-bottom: 0;
        width: 100%;
        position: relative;
    }
    
    .section-info {
        padding-right: 35px;
    }
    
    .section-name {
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 5px;
    }
    
    .section-check-card:hover .section-name {
        color: var(--secondary-color);
    }
    
    .section-checkbox:checked + .section-check-label .section-name {
        color: var(--primary-color);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // A√±adimos efecto de entrada a los grupos de formulario
        const formGroups = document.querySelectorAll('.form-group');
        formGroups.forEach((group, index) => {
            setTimeout(() => {
                group.style.opacity = '1';
            }, 100 * index);
        });
        
        // Efecto de focus al hacer clic en el label
        const labels = document.querySelectorAll('.form-label');
        labels.forEach(label => {
            label.addEventListener('click', function() {
                const input = document.getElementById(this.getAttribute('for'));
                if (input) {
                    input.focus();
                }
            });
        });
        
        // Previsualizaci√≥n de archivos PDF
        const pdfFileInput = document.getElementById('{{ form.pdf_file.id_for_label }}');
        const previewContainer = document.getElementById('pdf-preview-container');
        const pdfFilename = document.getElementById('pdf-filename');
        const pdfFilesize = document.getElementById('pdf-filesize');
        const pdfPreviewContent = document.getElementById('pdf-preview-content');
        const pdfPreviewIframe = document.getElementById('pdf-preview-iframe');
        const pdfPreviewToggle = document.getElementById('pdf-preview-toggle');
        const pdfPreviewClose = document.getElementById('pdf-preview-close');
        
        if (pdfFileInput) {
            pdfFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                
                if (file) {
                    // Mostrar la previsualizaci√≥n
                    previewContainer.classList.remove('d-none');
                    
                    // Actualizar informaci√≥n del archivo
                    pdfFilename.textContent = file.name;
                    
                    // Formatear el tama√±o del archivo
                    const fileSizeInKB = file.size / 1024;
                    const fileSizeInMB = file.size / 1024 / 1024;
                    let fileSizeStr = '';
                    
                    if (fileSizeInMB >= 1) {
                        fileSizeStr = fileSizeInMB.toFixed(2) + ' MB';
                    } else {
                        fileSizeStr = fileSizeInKB.toFixed(2) + ' KB';
                    }
                    
                    pdfFilesize.textContent = 'Tama√±o: ' + fileSizeStr;
                    
                    // Preparar URL para previsualizaci√≥n
                    const fileURL = URL.createObjectURL(file);
                    pdfPreviewIframe.src = fileURL;
                } else {
                    previewContainer.classList.add('d-none');
                    pdfPreviewIframe.src = '';
                }
            });
            
            // Bot√≥n para mostrar/ocultar la previsualizaci√≥n
            pdfPreviewToggle.addEventListener('click', function() {
                if (pdfPreviewContent.classList.contains('d-none')) {
                    pdfPreviewContent.classList.remove('d-none');
                    this.innerHTML = '<i class="fas fa-eye-slash me-1"></i> Ocultar documento';
                } else {
                    pdfPreviewContent.classList.add('d-none');
                    this.innerHTML = '<i class="fas fa-eye me-1"></i> Ver documento';
                }
            });
            
            // Bot√≥n para quitar el archivo
            pdfPreviewClose.addEventListener('click', function() {
                pdfFileInput.value = '';
                previewContainer.classList.add('d-none');
                pdfPreviewContent.classList.add('d-none');
                pdfPreviewIframe.src = '';
                pdfPreviewToggle.innerHTML = '<i class="fas fa-eye me-1"></i> Ver documento';
            });
        }

        // JavaScript espec√≠fico para el selector de secciones (JavaScript vanilla)
        function initializeSectionSelector() {
            // Manejar clics en las tarjetas de secci√≥n
            document.querySelectorAll('.section-check-card').forEach(function(card) {
                card.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        var checkbox = this.querySelector('.section-checkbox');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            updateSectionCount();
                        }
                    }
                });
            });
            
            // Manejar cambios en los checkboxes
            document.querySelectorAll('.section-checkbox').forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    updateSectionCount();
                });
            });
            
            // Funci√≥n para actualizar el contador de secciones seleccionadas
            function updateSectionCount() {
                var checkboxes = document.querySelectorAll('.section-checkbox');
                var selectedCount = document.querySelectorAll('.section-checkbox:checked').length;
                var totalCount = checkboxes.length;
                
                // Actualizar texto del contador si existe
                var sectionCountDisplay = document.querySelector('.section-count-display');
                if (!sectionCountDisplay) {
                    var sectionSelector = document.querySelector('.section-selector');
                    if (sectionSelector) {
                        var countHtml = '<div class="section-count-display mb-2">' +
                            '<small class="text-muted">' +
                            '<i class="fas fa-check-circle me-1"></i>' +
                            '<span class="selected-count">' + selectedCount + '</span> de <span class="total-count">' + totalCount + '</span> secciones seleccionadas' +
                            '</small>' +
                            '</div>';
                        sectionSelector.insertAdjacentHTML('afterbegin', countHtml);
                        sectionCountDisplay = document.querySelector('.section-count-display');
                    }
                } else {
                    var selectedCountSpan = sectionCountDisplay.querySelector('.selected-count');
                    if (selectedCountSpan) {
                        selectedCountSpan.textContent = selectedCount;
                    }
                }
                
                // Cambiar color del contador seg√∫n la selecci√≥n
                if (sectionCountDisplay) {
                    sectionCountDisplay.classList.remove('text-success', 'text-primary', 'text-warning');
                    if (selectedCount === 0) {
                        sectionCountDisplay.classList.add('text-warning');
                    } else if (selectedCount === totalCount) {
                        sectionCountDisplay.classList.add('text-success');
                    } else {
                        sectionCountDisplay.classList.add('text-primary');
                    }
                }
            }
            
            // Agregar botones de selecci√≥n r√°pida si hay m√∫ltiples secciones
            var checkboxes = document.querySelectorAll('.section-checkbox');
            if (checkboxes.length > 1) {
                var sectionSelector = document.querySelector('.section-selector');
                if (sectionSelector) {
                    var quickActionsHtml = '<div class="section-quick-actions mb-3">' +
                        '<button type="button" class="btn btn-outline-primary btn-sm me-2" id="selectAllSections">' +
                        '<i class="fas fa-check-double me-1"></i>Seleccionar Todas' +
                        '</button>' +
                        '<button type="button" class="btn btn-outline-secondary btn-sm" id="deselectAllSections">' +
                        '<i class="fas fa-times me-1"></i>Deseleccionar Todas' +
                        '</button>' +
                        '</div>';
                    sectionSelector.insertAdjacentHTML('afterbegin', quickActionsHtml);
                    
                    // Manejar seleccionar todas
                    document.getElementById('selectAllSections').addEventListener('click', function() {
                        document.querySelectorAll('.section-checkbox').forEach(function(checkbox) {
                            checkbox.checked = true;
                        });
                        updateSectionCount();
                    });
                    
                    // Manejar deseleccionar todas
                    document.getElementById('deselectAllSections').addEventListener('click', function() {
                        document.querySelectorAll('.section-checkbox').forEach(function(checkbox) {
                            checkbox.checked = false;
                        });
                        updateSectionCount();
                    });
                }
            }
            
            // Inicializar contador
            updateSectionCount();
        }
        
        // Inicializar el selector de secciones cuando el DOM est√© listo
        initializeSectionSelector();
        
        // Manejar el env√≠o del formulario
        const form = document.querySelector('form[method="post"]');
        const submitBtn = document.querySelector('.btn-primary-custom');
        
        if (form && submitBtn) {
            // Prevenir m√∫ltiples env√≠os
            form.addEventListener('submit', function(e) {
                // Verificar que el bot√≥n no est√© ya deshabilitado
                if (submitBtn.disabled) {
                    e.preventDefault();
                    return false;
                }
                
                // Iniciar animaciones de carga
                startLoadingAnimations();
                
                // Deshabilitar el bot√≥n y cambiar su texto
                submitBtn.disabled = true;
                submitBtn.style.cursor = 'not-allowed';
                
                console.log('Formulario enviado correctamente');
                
                // MEJORADO: Despu√©s del env√≠o, inicializar seguimiento real del progreso
                setTimeout(() => {
                    // Si el formulario se env√≠a exitosamente, redirigir√° autom√°ticamente
                    // pero mientras tanto, podemos mostrar mensajes realistas
                    const loadingMessages = [
                        { text: 'üß† Analizando el tema con inteligencia artificial...', delay: 2000, color: '#28a745' },
                        { text: 'üéì Adaptando contenido para estudiantes...', delay: 4000, color: '#ffc107' },
                        { text: 'üìö Construyendo estructura pedag√≥gica...', delay: 6000, color: '#e67e22' },
                        { text: 'üí° Generando ejemplos creativos...', delay: 8000, color: '#8e44ad' },
                        { text: 'üéØ Dise√±ando actividades interactivas...', delay: 10000, color: '#17a2b8' }
                    ];
                    
                    loadingMessages.forEach((msg) => {
                        setTimeout(() => {
                            updateLoadingMessage(msg.text, msg.color);
                        }, msg.delay);
                    });
                }, 1000);
            });
            
            // Asegurar que el bot√≥n funcione al hacer clic
            submitBtn.addEventListener('click', function(e) {
                console.log('Bot√≥n clickeado');
                
                // Si el formulario es v√°lido, proceder con el env√≠o
                if (form.checkValidity()) {
                    console.log('Formulario v√°lido, enviando...');
                    // El evento submit se disparar√° autom√°ticamente
                } else {
                    console.log('Formulario inv√°lido, mostrando errores');
                    form.reportValidity();
                }
            });
        }
        
        // Funci√≥n auxiliar para obtener par√°metros de URL
        function getUrlParameter(name) {
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            var results = regex.exec(window.location.href);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        
        // Funci√≥n para mostrar toast notifications
        function showToast(message, type) {
            // Crear contenedor de toast si no existe
            var toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
                document.body.appendChild(toastContainer);
            }
            
            // Crear toast
            var toast = document.createElement('div');
            toast.className = 'toast show';
            toast.style.cssText = 'margin-bottom: 10px;';
            
            var toastClass = 'bg-success';
            var icon = 'fa-check-circle';
            if (type === 'error') {
                toastClass = 'bg-danger';
                icon = 'fa-exclamation-circle';
            } else if (type === 'warning') {
                toastClass = 'bg-warning';
                icon = 'fa-exclamation-triangle';
            }
            
            toast.innerHTML = `
                <div class="toast-header ${toastClass} text-white">
                    <i class="fas ${icon} me-2"></i>
                    <strong class="me-auto">${type === 'error' ? 'Error' : type === 'warning' ? 'Advertencia' : '√âxito'}</strong>
                    <button type="button" class="btn-close btn-close-white ms-2" onclick="this.closest('.toast').remove()"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto-remove despu√©s de 5 segundos
            setTimeout(function() {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 5000);
        }
        
        // En la funci√≥n de asignaci√≥n del material, verificar secciones seleccionadas
        function assignToPortfolio(contentId, materialType, materialName, topicId) {
            if (!contentId) {
                showToast('ID de contenido requerido', 'error');
                return;
            }
            
            // Verificar checkboxes de secciones solo para material de clase
            var selectedSections = [];
            if (materialType === 'class') {
                document.querySelectorAll('.section-checkbox:checked').forEach(function(checkbox) {
                    selectedSections.push(checkbox.value);
                });
                
                // Si hay secciones disponibles pero ninguna seleccionada
                var totalCheckboxes = document.querySelectorAll('.section-checkbox');
                if (totalCheckboxes.length > 0 && selectedSections.length === 0) {
                    showToast('Por favor selecciona al menos una secci√≥n', 'error');
                    return;
                }
                
                // Para debug
                console.log('Secciones seleccionadas:', selectedSections);
            }
            
            // Configurar datos seg√∫n el tipo de asignaci√≥n
            var assignmentData = {};
            
            if (materialType === 'class') {
                // Material de clase: necesita t√≠tulo del tema del curso y secciones
                var courseTopicElement = document.getElementById('course_topic_title') || document.querySelector('input[name="topic"]');
                var courseTopic = courseTopicElement ? courseTopicElement.value : getUrlParameter('topic') || '';
                
                if (!courseTopic) {
                    showToast('No se pudo obtener el tema del curso', 'error');
                    return;
                }
                
                assignmentData = {
                    content_id: contentId,
                    material_type: materialType,
                    material_name: materialName,
                    course_topic_title: courseTopic,
                    use_scorm_format: true,
                    target_sections: selectedSections  // Agregar secciones seleccionadas
                };
                
                console.log('üìö Datos para material de clase:', assignmentData);
            } else {
                // Material personalizado: necesita topic_id espec√≠fico
                if (!topicId) {
                    showToast('Debe seleccionar un tema espec√≠fico para material personalizado', 'error');
                    return;
                }
                
                assignmentData = {
                    content_id: contentId,
                    material_type: materialType,
                    topic_id: topicId,
                    material_name: materialName
                };
                
                console.log('üë§ Datos para material personalizado:', assignmentData);
            }
            
            // Resto de la funci√≥n assignToPortfolio...
            // [contin√∫a con el c√≥digo de env√≠o AJAX]
        }
        
        // ========================================
        // ANIMACIONES DE CARGA MEJORADAS
        // ========================================
        
        function startLoadingAnimations() {
            const submitBtn = document.querySelector('.btn-primary-custom');
            if (!submitBtn) return;
            
            // Crear overlay de carga
            createLoadingOverlay();
            
            // Mensajes de progreso din√°micos M√ÅS EMOCIONANTES
            const loadingMessages = [
                { text: 'üöÄ ¬°Iniciando la magia educativa! Preparando tu contenido...', delay: 0, color: '#3e82fc' },
                { text: 'üß† Analizando el tema con inteligencia artificial avanzada...', delay: 1500, color: '#28a745' },
                { text: 'üéì Adaptando contenido para estudiantes de ' + getGradeLevel() + '...', delay: 3000, color: '#ffc107' },
                { text: 'üî¨ Construyendo estructura pedag√≥gica innovadora...', delay: 4500, color: '#e67e22' },
                { text: 'üí° Generando ejemplos s√∫per creativos y actuales...', delay: 6000, color: '#8e44ad' },
                { text: 'üéØ Dise√±ando actividades interactivas espectaculares...', delay: 7500, color: '#17a2b8' },
                { text: 'üìä Creando evaluaciones inteligentes y justas...', delay: 9000, color: '#dc3545' },
                { text: 'üé® Aplicando dise√±o visual moderno y atractivo...', delay: 10500, color: '#fd7e14' },
                { text: 'üåü Integrando tecnolog√≠a educativa de vanguardia...', delay: 12000, color: '#6f42c1' },
                { text: '‚ú® Puliendo cada detalle para la perfecci√≥n...', delay: 13500, color: '#20c997' },
                { text: 'üé≠ Agregando elementos din√°micos y multimedia...', delay: 15000, color: '#e83e8c' },
                { text: 'üî• ¬°Casi terminado! Aplicando √∫ltimos toques m√°gicos...', delay: 16500, color: '#fd7e14' },
                { text: 'üéâ ¬°LISTO! Tu contenido educativo espectacular est√° aqu√≠...', delay: 18000, color: '#28a745' }
            ];
            
            // Mostrar mensajes progresivamente con efectos din√°micos
            loadingMessages.forEach((msg, index) => {
                setTimeout(() => {
                    updateLoadingMessage(msg.text, msg.color);
                    updateLoadingProgress((index + 1) / loadingMessages.length * 100);
                    
                    // Efecto de part√≠culas en el √∫ltimo mensaje
                    if (index === loadingMessages.length - 1) {
                        setTimeout(() => {
                            createCelebrationEffect();
                        }, 1000);
                    }
                }, msg.delay);
            });
            
            // Animar el bot√≥n con diferentes estados
            animateSubmitButton();
        }
        
        function createLoadingOverlay() {
            // Crear overlay si no existe
            let overlay = document.getElementById('loading-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loading-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 9999;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    backdrop-filter: blur(5px);
                `;
                
                overlay.innerHTML = `
                    <div style="
                        background: white;
                        padding: 40px;
                        border-radius: 20px;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                        text-align: center;
                        max-width: 500px;
                        width: 90%;
                        animation: fadeInScale 0.5s ease-out;
                    ">
                        <div style="
                            width: 80px;
                            height: 80px;
                            border: 4px solid #e3f2fd;
                            border-top: 4px solid #3e82fc;
                            border-radius: 50%;
                            animation: spin 1s linear infinite;
                            margin: 0 auto 20px;
                        "></div>
                        
                        <h3 style="color: #3e82fc; margin-bottom: 20px; font-size: 1.4rem;">
                            üéì Generando Contenido Educativo
                        </h3>
                        
                        <div style="
                            background: #f8f9fa;
                            border-radius: 10px;
                            padding: 15px;
                            margin-bottom: 20px;
                        ">
                            <div id="loading-message" style="
                                color: #2c3e50;
                                font-size: 1.1rem;
                                margin-bottom: 15px;
                                min-height: 25px;
                                transition: all 0.3s ease;
                                transform: translateX(0);
                                opacity: 1;
                            ">
                                üöÄ Iniciando generaci√≥n de contenido educativo...
                            </div>
                            
                            <div style="
                                background: #e9ecef;
                                border-radius: 15px;
                                height: 8px;
                                overflow: hidden;
                                margin-bottom: 10px;
                            ">
                                <div id="loading-progress" style="
                                    background: linear-gradient(90deg, #3e82fc, #ff6b6b);
                                    height: 100%;
                                    width: 0%;
                                    border-radius: 15px;
                                    transition: width 0.3s ease;
                                "></div>
                            </div>
                            
                            <div style="
                                color: #6c757d;
                                font-size: 0.9rem;
                            ">
                                <span id="progress-percentage">0%</span> completado
                            </div>
                        </div>
                        
                        <p style="
                            color: #6c757d;
                            font-size: 0.9rem;
                            margin: 0;
                        ">
                            ‚è±Ô∏è Tiempo estimado: 4-5 minutos<br>
                            üí° Esto puede tomar hasta 5 minutos. Por favor, no cierres esta ventana.
                        </p>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                // Agregar estilos de animaci√≥n MEJORADOS
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    
                    @keyframes fadeInScale {
                        0% { 
                            opacity: 0; 
                            transform: scale(0.8) rotate(-5deg); 
                        }
                        50% {
                            transform: scale(1.05) rotate(2deg);
                        }
                        100% { 
                            opacity: 1; 
                            transform: scale(1) rotate(0deg); 
                        }
                    }
                    
                    @keyframes messageGlow {
                        0% { 
                            transform: translateX(-10px) scale(0.95);
                            opacity: 0;
                        }
                        50% {
                            transform: translateX(5px) scale(1.02);
                            opacity: 0.8;
                        }
                        100% { 
                            transform: translateX(0) scale(1);
                            opacity: 1;
                        }
                    }
                    
                    @keyframes progressPulse {
                        0%, 100% { box-shadow: 0 0 5px rgba(62, 130, 252, 0.5); }
                        50% { box-shadow: 0 0 20px rgba(62, 130, 252, 0.8); }
                    }
                    
                    @keyframes celebration {
                        0% { transform: scale(1) rotate(0deg); }
                        25% { transform: scale(1.1) rotate(-5deg); }
                        50% { transform: scale(1.05) rotate(5deg); }
                        75% { transform: scale(1.08) rotate(-3deg); }
                        100% { transform: scale(1) rotate(0deg); }
                    }
                    
                    @keyframes confetti {
                        0% { 
                            transform: translateY(-100vh) rotate(0deg);
                            opacity: 1;
                        }
                        100% { 
                            transform: translateY(100vh) rotate(720deg);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // En su lugar, solo mostramos el mensaje inicial y dejamos que el backend maneje el progreso
            updateLoadingMessage('üöÄ Iniciando generaci√≥n de contenido educativo...', '#3e82fc');
        }
        
        function updateLoadingMessage(message, color = '#2c3e50') {
            const messageElement = document.getElementById('loading-message');
            if (messageElement) {
                // Animaci√≥n de salida
                messageElement.style.transform = 'translateX(-20px)';
                messageElement.style.opacity = '0';
                
                setTimeout(() => {
                    messageElement.textContent = message;
                    messageElement.style.color = color;
                    messageElement.style.fontWeight = 'bold';
                    messageElement.style.textShadow = `0 0 10px ${color}40`;
                    
                    // Animaci√≥n de entrada
                    messageElement.style.transform = 'translateX(0)';
                    messageElement.style.opacity = '1';
                    messageElement.style.animation = 'messageGlow 0.6s ease-in-out';
                    
                    setTimeout(() => {
                        messageElement.style.animation = '';
                    }, 600);
                }, 200);
            }
        }
        
        function updateLoadingProgress(percentage) {
            const progressBar = document.getElementById('loading-progress');
            const progressText = document.getElementById('progress-percentage');
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
                progressBar.style.animation = 'progressPulse 1s ease-in-out';
                
                // Cambiar color seg√∫n progreso
                if (percentage >= 90) {
                    progressBar.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
                } else if (percentage >= 70) {
                    progressBar.style.background = 'linear-gradient(90deg, #ffc107, #fd7e14)';
                } else if (percentage >= 40) {
                    progressBar.style.background = 'linear-gradient(90deg, #17a2b8, #6f42c1)';
                }
                
                setTimeout(() => {
                    progressBar.style.animation = '';
                }, 1000);
            }
            
            if (progressText) {
                const oldText = progressText.textContent;
                progressText.textContent = Math.round(percentage) + '%';
                
                // Animaci√≥n de n√∫mero cambiando
                if (oldText !== progressText.textContent) {
                    progressText.style.transform = 'scale(1.2)';
                    progressText.style.color = '#28a745';
                    setTimeout(() => {
                        progressText.style.transform = 'scale(1)';
                        progressText.style.color = '#6c757d';
                    }, 300);
                }
            }
        }
        
        function createCelebrationEffect() {
            const overlay = document.getElementById('loading-overlay');
            if (!overlay) return;
            
            // Efecto de celebraci√≥n en el contenedor principal
            const mainContainer = overlay.querySelector('div');
            if (mainContainer) {
                mainContainer.style.animation = 'celebration 1s ease-in-out';
            }
            
            // Crear part√≠culas de confetti
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    createConfettiParticle();
                }, i * 100);
            }
            
            // Cambiar mensaje final con efecto especial
            setTimeout(() => {
                const messageElement = document.getElementById('loading-message');
                if (messageElement) {
                    messageElement.style.background = 'linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3)';
                    messageElement.style.backgroundClip = 'text';
                    messageElement.style.webkitBackgroundClip = 'text';
                    messageElement.style.color = 'transparent';
                    messageElement.style.fontSize = '1.3rem';
                    messageElement.style.animation = 'celebration 2s ease-in-out infinite';
                }
            }, 500);
        }
        
        function createConfettiParticle() {
            const overlay = document.getElementById('loading-overlay');
            if (!overlay) return;
            
            const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#5f27cd'];
            const particle = document.createElement('div');
            
            particle.style.cssText = `
                position: absolute;
                width: 8px;
                height: 8px;
                background: ${colors[Math.floor(Math.random() * colors.length)]};
                left: ${Math.random() * 100}%;
                top: -10px;
                border-radius: 50%;
                pointer-events: none;
                animation: confetti 3s linear;
                z-index: 10001;
            `;
            
            overlay.appendChild(particle);
            
            // Remover part√≠cula despu√©s de la animaci√≥n
            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 3000);
        }
        
        function animateSubmitButton() {
            const submitBtn = document.querySelector('.btn-primary-custom');
            if (!submitBtn) return;
            
            const buttonStates = [
                { text: 'üöÄ Iniciando...', color: '#3e82fc' },
                { text: 'üìö Analizando...', color: '#28a745' },
                { text: 'üéì Procesando...', color: '#ffc107' },
                { text: 'üí° Generando...', color: '#e67e22' },
                { text: 'üé® Dise√±ando...', color: '#8e44ad' },
                { text: '‚ú® Finalizando...', color: '#17a2b8' }
            ];
            
            buttonStates.forEach((state, index) => {
                setTimeout(() => {
                    submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i> ${state.text}`;
                    submitBtn.style.background = state.color;
                }, index * 4000);
            });
        }
        
        function getGradeLevel() {
            const gradeLevelSelect = document.querySelector('select[name="grade_level"]');
            if (gradeLevelSelect) {
                const selectedOption = gradeLevelSelect.options[gradeLevelSelect.selectedIndex];
                return selectedOption ? selectedOption.text : 'estudiantes';
            }
            return 'estudiantes';
        }
        
        // Funci√≥n para limpiar animaciones (se ejecuta cuando se carga la p√°gina de resultado)
        function cleanupLoadingAnimations() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.remove();
            }
        }
        
        // Limpiar animaciones si hay errores
        window.addEventListener('error', cleanupLoadingAnimations);
        
    });
</script>

<!-- Script para seguimiento de progreso real -->
<script src="{% static 'ai_content_generator/js/progress_tracker.js' %}"></script>

{% endblock %} 